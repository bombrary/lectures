<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="/assets/css/style.css">
    <title>D3js Part1</title>
    
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  displayAlign: "left",
  displayIndent: "2em",
  TeX: {
    equationNumbers: { autoNumber: "AMS" },
  },
  tex2jax: {
    inlineMath: [['$','$'], ['\\(','\\)']],
    processEscapes: true
  }
});
</script>
<script
   type="text/javascript"
   charset="utf-8"
   src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


    <script src="/assets/js/jquery-3.4.1.min.js"></script>
  </head>
  <body>

    <main>
      
      <section class="sidebar">
          <aside>
  <h3> D3js Part1 </h3>
  <img src="img/circle_alignment.png">
  <ul class="sidebar-ul">
    <li><a href="#case-01-タグ用意">Case01 - タグ用意</a></li>
    <li><a href="#case-02-タグ少ない">Case02 - タグ少ない</a></li>
    <li><a href="#case-03-データ少ない">Case03 - データ少ない</a></li>
    <li><a href="#込み入った話">CaseXX - 込み入った話</a></li>
    <li><a href="#case-04-関数化">Case04 - 関数化</a></li>
    <li><a href="#case-05-テキストを入れる">Case05 - テキストを入れる</a></li>
    <li><a href="#case-06-animation">Case06 - Animation</a></li>
    <li><a href="#case-07-relative-radius">Case07 - Relative Radius</a></li>
    <li><a href="#case-08-color">Case08 - Color</a>
      <ul>
        <li><a href="#case-08-1-random-color">1 - Random Color</a></li>
        <li><a href="#case-08-2-color-scheme">2 - Color Scheme</a></li>
        <li><a href="#case-08-3-linear-color-scale">3 - Linear Color Scale</a></li>
      </ul>
    </li>
    <li><a href="#case-09-click">Case09 - Click</a>
      <ul>
        <li><a href="#1st-method-rebind">1st Method - Rebind</a></li>
        <li><a href="#2nd-method-update-directly">2nd Method - Update Directly</a></li>
        <li><a href="#interactive-process">Interactive Process</a></li>
      </ul>
    </li>
    <li><a href="#case-10-input-area">Case10 - Input Area</a></li>
    <li><a href="#case-11-random-numbers">Case11 - Random Numbers</a></li>
    <li><a href="#まとめ">まとめ</a></li>
  </ul>
</aside>

      </section>
      <section class="main has-sidebar">
        <header>
  <div id="nav-drawer">
  <input id="nav-input" type="checkbox" class="nav-unshown" />
  <label id="nav-open" for="nav-input"><span></span></label>
  <label class="nav-unshown" id="nav-close" for="nav-input"></label>
  <div id="nav-content"></div>
  </div>
</header>

<script>
$('aside').clone(true)
  .appendTo('#nav-content');
</script>

<h1 id="d3js-part1---understanding-concept">D3js Part1 - Understanding Concept</h1>

<p>本チュートリアルでは、「配列に入った数値データを円として可視化する」というケースを想定して、D3.jsの基本を学んでいきます。</p>

<h2 id="お約束">お約束</h2>

<p>まずは基本形を見せます。index.htmlを作成し、以下のように書いてください。</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">"ja"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"utf-8"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">"stylesheet"</span> <span class="na">href=</span><span class="s">"style.css"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;/head&gt;</span>
  <span class="nt">&lt;body&gt;</span>
    <span class="c">&lt;!-- ここに色々書いていきます --&gt;</span>
    <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"https://d3js.org/d3.v5.min.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
    <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"script.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div>

<p>ありふれたhtmlファイルなので詳細については省略しますが、以下の文</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"https://d3js.org/d3.v5.min.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
</code></pre></div></div>

<p>については補足しておきます。この文によって、インターネットからd3.jsのファイルを読み込んでいます。</p>

<h2 id="case-01-タグ用意">Case 01: タグ用意</h2>

<p>index.htmlに以下のsvgタグとcircleタグを追加しておきます。</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>...
<span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;svg&gt;</span>
      <span class="nt">&lt;circle&gt;&lt;/circle&gt;</span>
      <span class="nt">&lt;circle&gt;&lt;/circle&gt;</span>
      <span class="nt">&lt;circle&gt;&lt;/circle&gt;</span>
    <span class="nt">&lt;/svg&gt;</span>
    <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"https://d3js.org/d3.v5.min.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
    <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"script.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
<span class="nt">&lt;/body&gt;</span>
...
</code></pre></div></div>

<p>まずは簡単に、以下のケースを考えてみましょう。</p>
<ul>
  <li>データ[4, 2, 10]とcircleを結びつけたい</li>
  <li>circleの半径をデータの値にしたい</li>
  <li>circleを横並びにしたい</li>
</ul>

<p>実現は簡単です。script.jsを作成し、以下のように書きましょう。</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="p">[</span><span class="nx">svgWidth</span><span class="p">,</span> <span class="nx">svgHeight</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">600</span><span class="p">,</span> <span class="mi">800</span><span class="p">];</span>
<span class="kd">const</span> <span class="nx">svg</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s1">'svg'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'width'</span><span class="p">,</span> <span class="nx">svgWidth</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'height'</span><span class="p">,</span> <span class="nx">svgHeight</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">data</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">10</span><span class="p">];</span>

<span class="nx">svg</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">'circle'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">data</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> 
  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'cx'</span><span class="p">,</span> <span class="p">(</span><span class="nx">d</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">node</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="mi">30</span><span class="o">*</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">40</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'cy'</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'r'</span><span class="p">,</span> <span class="p">(</span><span class="nx">d</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">node</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">d</span><span class="p">);</span>
</code></pre></div></div>

<p>index.htmlを開くと、次のように表示されます。</p>

<p><img src="/d3js/Part01/img/circle02.png" alt="" /></p>

<p>画面右側はDevelopper Toolでの出力です。Developperツールは、Google ChromeならF12、Safariならcommand + option + iキーで開くことができます。
circleタグにcx、cy、r属性が追加されていることがわかります。</p>

<h3 id="説明">説明</h3>

<p>一つづつ見ていきましょう。</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="p">[</span><span class="nx">svgWidth</span><span class="p">,</span> <span class="nx">svgHeight</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">600</span><span class="p">,</span> <span class="mi">800</span><span class="p">];</span>
</code></pre></div></div>

<p>は、後で利用するためのsvgWidth、svgHeightを設定しています。
JavaScriptの機能である「分割代入」を利用しています。</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">svg</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s1">'svg'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'width'</span><span class="p">,</span> <span class="nx">svgWidth</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'height'</span><span class="p">,</span> <span class="nx">svgHeight</span><span class="p">);</span>
</code></pre></div></div>

<p>HTMLタグ(厳密にはその<strong>DOM</strong>)を選択するにはselectメソッドを使います。さらに返ってきた値に対してattrメソッドを利用することで、htmlタグの属性を変更することができます。
ここでは、svgタグを選択してそのwidthをsvgWidthに、heightをsvgHeightを設定しています。</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">data</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">10</span><span class="p">];</span>
</code></pre></div></div>

<p>これは[4,2,10]という配列を用意しているだけですね。</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">svg</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">'circle'</span><span class="p">)</span>
</code></pre></div></div>

<p>によって、circleタグ全てを選択することを意味します。選択したcircleに対して、</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">svg</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">'circle'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">data</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> 
</code></pre></div></div>

<p>とします。dataメソッドによって、用意された配列dataとcircleタグを結びつけます。data配列とは</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">data</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">10</span><span class="p">];</span>
</code></pre></div></div>

<p>であったわけですから、一つのcircleタグには4、一つのcircleタグには2、一つのciecleタグには10という値が結びつけられます。
この結びつける操作のことを「data bind」や「data join」と呼びます。</p>

<p>さて、dataメソッドによってciecleタグとデータが結びつきました。結びついたデータを用いて半径や位置を変更してみましょう。</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">svg</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">'circle'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">data</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> 
  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'cx'</span><span class="p">,</span> <span class="p">(</span><span class="nx">d</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">node</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="mi">30</span><span class="o">*</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">40</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'cy'</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'r'</span><span class="p">,</span> <span class="p">(</span><span class="nx">d</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">node</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">d</span><span class="p">);</span>
</code></pre></div></div>

<p>attrメソッドには定数を指定することも可能です。しかし結びついたデータを用いて属性をいじるためには関数を指定してあげます。
例えば次の行</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'cx'</span><span class="p">,</span> <span class="p">(</span><span class="nx">d</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">node</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="mi">30</span><span class="o">*</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">40</span><span class="p">)</span>
</code></pre></div></div>

<p>では、cx属性を変更しています。第二引数では無名関数を指定していますが、この引数は以下のようになっています。</p>

<pre><code class="language-txt">(結びついたデータ, 何番目のDOMか, DOMの配列) =&gt; { 関数の内容 }
</code></pre>

<p>今回の文については、</p>

<ul>
  <li>1つ目のcircleのx座標は40</li>
  <li>2つ目のcircleのx座標は70</li>
  <li>3つ目のcircleのx座標は100</li>
</ul>

<p>と配置されます。</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'r'</span><span class="p">,</span> <span class="p">(</span><span class="nx">d</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">node</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">d</span><span class="p">);</span>
</code></pre></div></div>

<p>については、</p>

<ul>
  <li>1つ目のcircleの半径は4</li>
  <li>2つ目のcircleの半径は2</li>
  <li>3つ目のcircleの半径は10</li>
</ul>

<p>となります。</p>

<p>ちなみに、いらない引数は次のように省略できます。ただし「1番目の引数はデータ、2番目の引数はDOMの番号、3番目の引数はDOMの配列」であるという順番は守る必要があります。</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">svg</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">'circle'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">data</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> 
  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'cx'</span><span class="p">,</span> <span class="p">(</span><span class="nx">d</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="mi">30</span><span class="o">*</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">40</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'cy'</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'r'</span><span class="p">,</span> <span class="nx">d</span> <span class="o">=&gt;</span> <span class="nx">d</span><span class="p">);</span>
</code></pre></div></div>

<h3 id="気持ち">気持ち</h3>

<p>表示してみてわかると思いますが、円は非常に小さいです。しかも位置は左上なので、真ん中に寄せたいです。</p>

<h3 id="modify">Modify</h3>

<p>circleタグをgタグで括ります。これは、後で中央寄せするための準備です。</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>...
<span class="nt">&lt;body&gt;</span>
  <span class="nt">&lt;svg&gt;</span>
    <span class="nt">&lt;g&gt;</span>
      <span class="nt">&lt;circle&gt;&lt;/circle&gt;</span>
      <span class="nt">&lt;circle&gt;&lt;/circle&gt;</span>
      <span class="nt">&lt;circle&gt;&lt;/circle&gt;</span>
    <span class="nt">&lt;/g&gt;</span>
  <span class="nt">&lt;/svg&gt;</span>
  <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"https://d3js.org/d3.v5.min.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
  <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"script.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
<span class="nt">&lt;/body&gt;</span>
...
</code></pre></div></div>

<p>script.jsを次のようにします。</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="p">[</span><span class="nx">svgWidth</span><span class="p">,</span> <span class="nx">svgHeight</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">600</span><span class="p">,</span> <span class="mi">800</span><span class="p">];</span>
<span class="kd">const</span> <span class="nx">svg</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s1">'svg'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'width'</span><span class="p">,</span> <span class="nx">svgWidth</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'height'</span><span class="p">,</span> <span class="nx">svgHeight</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">data</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">10</span><span class="p">];</span>

<span class="nx">svg</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s1">'g'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'transform'</span><span class="p">,</span> <span class="s2">`translate(</span><span class="p">${</span><span class="nx">svgWidth</span><span class="o">/</span><span class="mi">2</span><span class="p">}</span><span class="s2">, </span><span class="p">${</span><span class="nx">svgHeight</span><span class="o">/</span><span class="mi">2</span><span class="p">}</span><span class="s2">)`</span><span class="p">);</span>
<span class="nx">svg</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">'circle'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">data</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> 
  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'cx'</span><span class="p">,</span> <span class="p">(</span><span class="nx">d</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="mi">30</span><span class="o">*</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">40</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'cy'</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'r'</span><span class="p">,</span> <span class="nx">d</span> <span class="o">=&gt;</span> <span class="mi">3</span><span class="o">*</span><span class="nx">d</span><span class="p">);</span>
</code></pre></div></div>

<p>追加箇所は次の文です。</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">svg</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s1">'g'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'transform'</span><span class="p">,</span> <span class="s2">`translate(</span><span class="p">${</span><span class="nx">svgWidth</span><span class="o">/</span><span class="mi">2</span><span class="p">}</span><span class="s2">, </span><span class="p">${</span><span class="nx">svgHeight</span><span class="o">/</span><span class="mi">2</span><span class="p">}</span><span class="s2">)`</span><span class="p">);</span>
</code></pre></div></div>

<p>gタグにtransform属性を付けています。これはgタグそのものの移動や回転、拡大縮小を行うための属性です。translate(x, y)と書くことによって、gタグの位置を座標(x,y)にずらしています。こうすることで、円の集まりそのものを画像中心に移動させています。</p>

<p>また、円の半径が小さいので、とりあえず次のように「元データの3倍を半径」としてみます。</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'r'</span><span class="p">,</span> <span class="nx">d</span> <span class="o">=&gt;</span> <span class="mi">3</span><span class="o">*</span><span class="nx">d</span><span class="p">);</span>
</code></pre></div></div>

<p>円の半径は確かに中央寄せなのですが、円同士が重なってしまうようです。何故でしょう 🤔</p>

<p><img src="/d3js/Part01/img/circle03.png" alt="bg contain" /></p>

<p>理由は非常に単純です。円の位置を指定するための属性cx, cyはあくまで「円の中心位置の指定」です。現状、位置は単にデータの番号について等間隔に配置しているため、円の半径までは考慮していません。</p>

<p>ということで、円の半径を考慮して位置を計算したくなります。ここでは、「<strong>配列のデータを入力すると、画面出力のための位置、半径などのデータを返す</strong>」関数を作ってみましょう。そんな関数formatDataは、次のように使います。このような関数を定義することによるメリットについては、後ほど説明します。</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">data</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">10</span><span class="p">];</span>
<span class="kd">const</span> <span class="nx">formatData</span> <span class="o">=</span> <span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">space</span><span class="p">,</span> <span class="nx">mag</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// ここを埋めてね</span>
<span class="p">};</span>

<span class="nx">svg</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s1">'g'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'transform'</span><span class="p">,</span> <span class="s2">`translate(</span><span class="p">${</span><span class="nx">svgWidth</span><span class="o">/</span><span class="mi">2</span><span class="p">}</span><span class="s2">, </span><span class="p">${</span><span class="nx">svgHeight</span><span class="o">/</span><span class="mi">2</span><span class="p">}</span><span class="s2">)`</span><span class="p">);</span>
<span class="nx">svg</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">'circle'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">data</span><span class="p">(</span><span class="nx">formatData</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span> 
  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'cx'</span><span class="p">,</span> <span class="nx">d</span> <span class="o">=&gt;</span> <span class="nx">d</span><span class="p">.</span><span class="nx">x</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'cy'</span><span class="p">,</span> <span class="nx">d</span> <span class="o">=&gt;</span> <span class="nx">d</span><span class="p">.</span><span class="nx">y</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'r'</span><span class="p">,</span> <span class="nx">d</span> <span class="o">=&gt;</span> <span class="nx">d</span><span class="p">.</span><span class="nx">r</span><span class="p">);</span>
</code></pre></div></div>

<p>こんな感じの図にしましょう。</p>

<p><img src="/d3js/Part01/img/exercise01_01.svg" alt="bg right:50% contain" /></p>

<h2 id="example">Example</h2>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nx">formatData</span><span class="p">([</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">10</span><span class="p">],</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
 <span class="cm">/*
 [
   {val: 4, r: 20, x: 0, y: 0},
   {val: 2, r: 10, x: 40, y: 0},
   {val: 10, r: 50, x: 110, y: 0}
 ]
 */</span>
</code></pre></div></div>

<h2 id="solution">Solution</h2>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">formatData</span> <span class="o">=</span> <span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">space</span><span class="p">,</span> <span class="nx">mag</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">now</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kd">const</span> <span class="nx">ret</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">data</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">ret</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span> <span class="na">val</span><span class="p">:</span> <span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="na">r</span><span class="p">:</span> <span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">*</span> <span class="nx">mag</span><span class="p">,</span> <span class="na">x</span><span class="p">:</span> <span class="nx">now</span><span class="p">,</span> <span class="na">y</span><span class="p">:</span> <span class="mi">0</span> <span class="p">});</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">data</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">now</span> <span class="o">+=</span> <span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="o">*</span><span class="nx">mag</span> <span class="o">+</span> <span class="nx">space</span> <span class="o">+</span> <span class="nx">data</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="nx">mag</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">ret</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div></div>

<h2 id="extended-solution">Extended Solution</h2>

<p>完全に中央寄せになる</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">formatData</span> <span class="o">=</span> <span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">space</span><span class="p">,</span> <span class="nx">mag</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">now</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kd">const</span> <span class="nx">ret</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">d</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">t</span> <span class="o">=</span> <span class="p">{</span> <span class="na">val</span><span class="p">:</span> <span class="nx">d</span><span class="p">,</span> <span class="na">r</span><span class="p">:</span> <span class="nx">d</span> <span class="o">*</span> <span class="nx">mag</span><span class="p">,</span> <span class="na">x</span><span class="p">:</span> <span class="nx">now</span><span class="p">,</span> <span class="na">y</span><span class="p">:</span> <span class="mi">0</span> <span class="p">};</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">data</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">now</span> <span class="o">+=</span> <span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="o">*</span><span class="nx">mag</span> <span class="o">+</span> <span class="nx">space</span> <span class="o">+</span> <span class="nx">data</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="nx">mag</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">t</span><span class="p">;</span>
  <span class="p">});</span>
  <span class="nx">ret</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">d</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="nx">d</span><span class="p">.</span><span class="nx">x</span> <span class="o">-=</span> <span class="nx">now</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span> <span class="p">});</span>
  <span class="k">return</span> <span class="nx">ret</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div></div>

<p>さて、なぜこんな関数formatDataを作ったのでしょうか。単に位置を記録するだけなら、配列を別途用意して次のようにも書けそうです。</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">data</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">10</span><span class="p">];</span>

<span class="kd">const</span> <span class="nx">mag</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
<span class="kd">const</span> <span class="nx">x</span> <span class="o">=</span> <span class="p">[];</span>
<span class="kd">let</span> <span class="nx">now</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">data</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">x</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">now</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">data</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">now</span> <span class="o">+=</span> <span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="o">*</span><span class="nx">mag</span> <span class="o">+</span> <span class="nx">space</span> <span class="o">+</span> <span class="nx">data</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="nx">mag</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">svg</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s1">'g'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'transform'</span><span class="p">,</span> <span class="s2">`translate(</span><span class="p">${</span><span class="nx">svgWidth</span><span class="o">/</span><span class="mi">2</span><span class="p">}</span><span class="s2">, </span><span class="p">${</span><span class="nx">svgHeight</span><span class="o">/</span><span class="mi">2</span><span class="p">}</span><span class="s2">)`</span><span class="p">);</span>
<span class="nx">svg</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">'circle'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">data</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> 
  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'cx'</span><span class="p">,</span> <span class="p">(</span><span class="nx">d</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">x</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span>
  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'cy'</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'r'</span><span class="p">,</span> <span class="nx">mag</span> <span class="o">*</span> <span class="nx">d</span><span class="p">)</span>
</code></pre></div></div>

<p>しかしこのように書くと、magやxを他のデータに対して使いたい場合に、再利用が面倒です。
formatDataという関数でひとくくりにしてまとめることによって、
「データを出力用データに変換する」という処理を他のデータに再利用できます。位置や半径に少し変更をしたいという場合に、「formatDataという関数を編集すれば良いんだ」ということが分かりやすいと思います。</p>

<p>また、元データを{x座標, y座標, 半径}に変換してあげて、元データではなく変換後のデータを直接DOMと結びつけています。
こうすると、結ばれたデータ自身が位置情報、半径を持っているため、</p>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">svg</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">'circle'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">data</span><span class="p">(</span><span class="nx">formatData</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span> 
  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'cx'</span><span class="p">,</span> <span class="nx">d</span> <span class="o">=&gt;</span> <span class="nx">d</span><span class="p">.</span><span class="nx">x</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'cy'</span><span class="p">,</span> <span class="nx">d</span> <span class="o">=&gt;</span> <span class="nx">d</span><span class="p">.</span><span class="nx">y</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'r'</span><span class="p">,</span> <span class="nx">d</span> <span class="o">=&gt;</span> <span class="nx">d</span><span class="p">.</span><span class="nx">r</span><span class="p">);</span>
</code></pre></div></div>
<p>のように、データのプロパティにアクセスすることで円の半径や位置を変更できます。</p>

<p>このように、「元データを都合の良いデータに変換する」というような<strong>データの前処理</strong>は、
今後どんどん使っていきますので心に留めておきましょう。</p>

<p>さて、めでたく位置は中央寄せになりましたし、円同士の重なりは無くなりました。</p>

<p><img src="/d3js/Part01/img/circle04.png" alt="bg contain" /></p>

<p><strong>しかし、これで本当にめでたいですか?</strong></p>

<p>今回の場合、<strong>たまたま</strong>circleタグがちょうど3つ用意されていました。
しかし以下のケースを想定しましょう。</p>

<ul>
  <li>データ数が多い時にcircleタグをいちいち追加しますか?</li>
  <li>データ数が少ない時は?</li>
</ul>

<h2 id="case-02-タグ少ない">Case 02: タグ少ない</h2>

<p>htmlファイルについては何も変更はありません。</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>...
<span class="nt">&lt;svg&gt;</span>
  <span class="nt">&lt;g&gt;</span>
    <span class="nt">&lt;circle&gt;&lt;/circle&gt;</span>
    <span class="nt">&lt;circle&gt;&lt;/circle&gt;</span>
    <span class="nt">&lt;circle&gt;&lt;/circle&gt;</span>
  <span class="nt">&lt;/g&gt;</span>
<span class="nt">&lt;/svg&gt;</span>
...
</code></pre></div></div>

<p>しかし用意されているデータが次のように多かった場合を考えましょう。</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">data</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">2</span><span class="p">];</span>
</code></pre></div></div>

<p>すでにあるcircleタグはそのまま使って、足りないcircleは追加してあげる必要があります。データ目線からだと次のように処理をする必要があります。</p>

<ul>
  <li>結ばれたデータたち: さっきと同じように</li>
  <li>結ばれなかったデータたち: <strong>新たに作ってあげる</strong></li>
</ul>

<p>実際のコードは以下のようになります。</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">data</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">2</span><span class="p">];</span>
<span class="kd">const</span> <span class="nx">g</span> <span class="o">=</span> <span class="nx">svg</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s1">'g'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'transform'</span><span class="p">,</span> <span class="s2">`translate(</span><span class="p">${</span><span class="nx">svgWidth</span><span class="o">/</span><span class="mi">2</span><span class="p">}</span><span class="s2">, </span><span class="p">${</span><span class="nx">svgHeight</span><span class="o">/</span><span class="mi">2</span><span class="p">}</span><span class="s2">)`</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">circle</span> <span class="o">=</span> <span class="nx">g</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">'circle'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">data</span><span class="p">(</span><span class="nx">formatData</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">));</span>

<span class="c1">// formatDataは省略</span>

<span class="nx">circle</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'cx'</span><span class="p">,</span> <span class="nx">d</span> <span class="o">=&gt;</span> <span class="nx">d</span><span class="p">.</span><span class="nx">x</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'cy'</span><span class="p">,</span> <span class="nx">d</span> <span class="o">=&gt;</span> <span class="nx">d</span><span class="p">.</span><span class="nx">y</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'r'</span><span class="p">,</span> <span class="nx">d</span> <span class="o">=&gt;</span> <span class="nx">d</span><span class="p">.</span><span class="nx">r</span><span class="p">);</span>

<span class="kd">const</span> <span class="nx">circleEnter</span> <span class="o">=</span> <span class="nx">circle</span><span class="p">.</span><span class="nx">enter</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">'circle'</span><span class="p">);</span>
<span class="nx">circleEnter</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'cx'</span><span class="p">,</span> <span class="nx">d</span> <span class="o">=&gt;</span> <span class="nx">d</span><span class="p">.</span><span class="nx">x</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'cy'</span><span class="p">,</span> <span class="nx">d</span> <span class="o">=&gt;</span> <span class="nx">d</span><span class="p">.</span><span class="nx">y</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'r'</span><span class="p">,</span> <span class="nx">d</span> <span class="o">=&gt;</span> <span class="nx">d</span><span class="p">.</span><span class="nx">r</span><span class="p">);</span>
</code></pre></div></div>

<p>何やらcircleEnterというものが追加されました。これが「結ばれなかったデータたち」です。</p>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">circle</span><span class="p">.</span><span class="nx">enter</span><span class="p">()</span>
</code></pre></div></div>
<p>というもので、「結ばれなかったデータたち」にアクセスしています(厳密には「結ばれなかったデータ」という表現は誤りなのですが、これについての訂正はCase03の後で行います)。
さらに、</p>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">circleEnter</span> <span class="o">=</span> <span class="nx">circle</span><span class="p">.</span><span class="nx">enter</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">'circle'</span><span class="p">);</span>
</code></pre></div></div>
<p>によって、結ばれなかったデータに対して結び手circleを新たに追加してやります。これでめでたくデータに対応したcircleタグができたわけです。その後の処理は普通に座標、半径を設定しているだけです。</p>

<p>ところで、次の2つの文が似ていることに気づくと思います。</p>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">circle</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'cx'</span><span class="p">,</span> <span class="nx">d</span> <span class="o">=&gt;</span> <span class="nx">d</span><span class="p">.</span><span class="nx">x</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'cy'</span><span class="p">,</span> <span class="nx">d</span> <span class="o">=&gt;</span> <span class="nx">d</span><span class="p">.</span><span class="nx">y</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'r'</span><span class="p">,</span> <span class="nx">d</span> <span class="o">=&gt;</span> <span class="nx">d</span><span class="p">.</span><span class="nx">r</span><span class="p">);</span>
</code></pre></div></div>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">circleEnter</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'cx'</span><span class="p">,</span> <span class="nx">d</span> <span class="o">=&gt;</span> <span class="nx">d</span><span class="p">.</span><span class="nx">x</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'cy'</span><span class="p">,</span> <span class="nx">d</span> <span class="o">=&gt;</span> <span class="nx">d</span><span class="p">.</span><span class="nx">y</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'r'</span><span class="p">,</span> <span class="nx">d</span> <span class="o">=&gt;</span> <span class="nx">d</span><span class="p">.</span><span class="nx">r</span><span class="p">);</span>
</code></pre></div></div>
<p>これを実はこれを一括で書く方法があります。mergeメソッドを用いて、普通のデータとenterのデータを併合することができます。
これにより、重複部分を省くことができます。</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">...</span>

<span class="kd">const</span> <span class="nx">circle</span> <span class="o">=</span> <span class="nx">g</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">'circle'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">data</span><span class="p">(</span><span class="nx">formatData</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">));</span>

<span class="kd">const</span> <span class="nx">circleEnter</span> <span class="o">=</span> <span class="nx">circle</span><span class="p">.</span><span class="nx">enter</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">'circle'</span><span class="p">);</span>
<span class="nx">circleEnter</span><span class="p">.</span><span class="nx">merge</span><span class="p">(</span><span class="nx">circle</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'cx'</span><span class="p">,</span> <span class="nx">d</span> <span class="o">=&gt;</span> <span class="nx">d</span><span class="p">.</span><span class="nx">x</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'cy'</span><span class="p">,</span> <span class="nx">d</span> <span class="o">=&gt;</span> <span class="nx">d</span><span class="p">.</span><span class="nx">y</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'r'</span><span class="p">,</span> <span class="nx">d</span> <span class="o">=&gt;</span> <span class="nx">d</span><span class="p">.</span><span class="nx">r</span><span class="p">);</span>
</code></pre></div></div>

<p><img src="/d3js/Part01/img/circle05.png" alt="bg contain" /></p>

<p>いい感じですね。</p>

<h2 id="case-03-データ少ない">Case 03: データ少ない</h2>

<p>相変わらずのhtmlファイルです。</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>...
<span class="nt">&lt;svg&gt;</span>
  <span class="nt">&lt;g&gt;</span>
    <span class="nt">&lt;circle&gt;&lt;/circle&gt;</span>
    <span class="nt">&lt;circle&gt;&lt;/circle&gt;</span>
    <span class="nt">&lt;circle&gt;&lt;/circle&gt;</span>
  <span class="nt">&lt;/g&gt;</span>
<span class="nt">&lt;/svg&gt;</span>
...
</code></pre></div></div>

<p>しかしデータは2つしかありません。1つcircleタグが余計です。</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">data</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">];</span>
</code></pre></div></div>

<p>データと結びついたタグはそのまま使って、余ったcircleは削除してあげる必要があります。つまり、</p>

<ul>
  <li>結ばれたDOMたち: さっきと同じように</li>
  <li>結ばれなかったDOMたち: <strong>消し去る</strong></li>
</ul>

<p>ということを書いたコードが以下のようになります。</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">data</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">];</span>
<span class="kd">const</span> <span class="nx">g</span> <span class="o">=</span> <span class="nx">svg</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s1">'g'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'transform'</span><span class="p">,</span> <span class="s2">`translate(</span><span class="p">${</span><span class="nx">svgWidth</span><span class="o">/</span><span class="mi">2</span><span class="p">}</span><span class="s2">, </span><span class="p">${</span><span class="nx">svgHeight</span><span class="o">/</span><span class="mi">2</span><span class="p">}</span><span class="s2">)`</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">circle</span> <span class="o">=</span> <span class="nx">g</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">'circle'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">data</span><span class="p">(</span><span class="nx">formatData</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">));</span>

<span class="nx">circle</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'cx'</span><span class="p">,</span> <span class="nx">d</span> <span class="o">=&gt;</span> <span class="nx">d</span><span class="p">.</span><span class="nx">x</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'cy'</span><span class="p">,</span> <span class="nx">d</span> <span class="o">=&gt;</span> <span class="nx">d</span><span class="p">.</span><span class="nx">y</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'r'</span><span class="p">,</span> <span class="nx">d</span> <span class="o">=&gt;</span> <span class="nx">d</span><span class="p">.</span><span class="nx">r</span><span class="p">);</span>

<span class="nx">circle</span><span class="p">.</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span>
</code></pre></div></div>

<p>データに結ばれなかったDOMは</p>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">circle</span><span class="p">.</span><span class="nx">exit</span><span class="p">()</span>
</code></pre></div></div>
<p>で得られます(厳密には「結ばれなかったDOM」という表現は誤りなのですが、これについての訂正はCase03の後で行います)。
removeメソッドを使うとこれを削除することができます。</p>

<p><img src="/d3js/Part01/img/circle06.png" alt="bg contain" /></p>

<h2 id="込み入った話">込み入った話</h2>

<p>今までの話で、</p>

<ul>
  <li>circle.enter()ではDOMに結びつかなかったデータ得られる</li>
  <li>circle.exit()ではデータに結びつかなかったDOMが得られる</li>
</ul>

<p>と表現してきました。
厳密には、この表現は間違いです。<strong>circle.enter()やcircle.exit()の返り値は、DOMでもデータでもありません。</strong></p>

<h2 id="selections-オブジェクト"><em>selection(s)</em> オブジェクト</h2>

<p>例えば、</p>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">svg</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s1">'svg'</span><span class="p">);</span>
</code></pre></div></div>
<p>が返す値は、<em>selection</em>と呼ばれるオブジェクトです。この<em>selection</em>を介して、私たちはDOMの属性を操作したり、
DOMに子要素を追加/削除したり、データとDOMを結びつけたりしています。</p>

<p>selectで指定する引数は、cssのセレクタと同じ文法です。なので、例えば以下のように書けば、
contentをクラスとして持つDOMの<em>selection</em>を返します。</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">d3</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s1">'.content'</span><span class="p">)</span>
</code></pre></div></div>

<p>さらに、「svgを選択して、さらにその下のcircleを選択したい」という場合は、次のように書きます。</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">d3</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s1">'svg'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s1">'circle'</span><span class="p">);</span>

<span class="c1">// 次のように変数に一度格納することをよくやります</span>
<span class="kd">const</span> <span class="nx">svg</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s1">'svg'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">circle</span> <span class="o">=</span> <span class="nx">svg</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s1">'circle'</span><span class="p">);</span>
</code></pre></div></div>

<p>また、selectは一つの<em>selection</em>を返しましたが、selectAllは<em>selections</em>を返します。これは<em>selection</em>を複数集めた、配列に似たオブジェクトです。</p>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">d3</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">'circle'</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="selectionsdataの行く末"><em>selections</em>.dataの行く末</h3>

<p>すでにCase01から見ていきましたが、データとDOMを結びつけるためには、<em>selections</em>.dataメソッドを用います。
ただし、結びつける対象のDOMが必要なので、先にselectAllで選択しておきます。</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">svg</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">'circle'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">data</span><span class="p">([</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]);</span>
</code></pre></div></div>

<p>データとDOMが結びつくわけですが、Case01〜Case03で見た通り、タグが足りなかったりデータが足りなかったりするケースが存在します。
それに応じて、enterメソッドやexitメソッドでそれぞれの<em>selection</em>にアクセスするわけです。
enterやexitでアクセスされる<em>selections</em>には名前がついており、それぞれ<em>enter selections</em>、<em>exit selections</em>などと呼ばれます。
以上をまとめると、こんな感じで分類されます。</p>

<ul>
  <li>データとDOMが結ばれた: <em>update selections</em>
    <ul>
      <li><em>selections</em> でアクセス</li>
    </ul>
  </li>
  <li>DOM足りないんだけど?: <em>enter selections</em>
    <ul>
      <li><em>selections.enter()</em> でアクセス</li>
    </ul>
  </li>
  <li>データ足りないんだけど?: <em>exit selections</em>
    <ul>
      <li><em>selections.exit()</em> でアクセス</li>
    </ul>
  </li>
</ul>

<p>これを今まで見せてきた例に照らし合わせると、</p>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">circle</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">'circle'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">data</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
</code></pre></div></div>
<p>において、circleが<em>update selections</em>を表しており、</p>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">circleEnter</span> <span class="o">=</span> <span class="nx">circle</span><span class="p">.</span><span class="nx">enter</span><span class="p">()</span>
</code></pre></div></div>
<p>において、circle.enter()が<em>enter selections</em>を表しており、</p>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">circle</span><span class="p">.</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">()</span>
</code></pre></div></div>
<p>において、circle.exit()が<em>exit selections</em>を表しています。</p>

<h3 id="selectiondatum"><em>selection</em>.datum</h3>

<p>結ぶデータとDOMが1ペアしかないことが確実なら、datumというメソッドを利用します。
selectAllほど使用頻度は多くありません。</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 例1: 1つのcircleを選択して1つの値を結びつける</span>
<span class="c1">// ただしcircleが必ず存在している必要がある</span>
<span class="c1">// 半径を結びつけた値に設定する</span>
<span class="nx">d3</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s1">'circle'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">datum</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'r'</span><span class="p">,</span> <span class="nx">d</span> <span class="o">=&gt;</span> <span class="nx">d</span><span class="p">);</span>

<span class="c1">// 例2: appendでcircleを追加して1つの値を結びつける</span>
<span class="c1">// 半径を結びつけた値に設定する</span>
<span class="nx">d3</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s1">'svg'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">'circle'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">datum</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'r'</span><span class="p">,</span> <span class="nx">d</span> <span class="o">=&gt;</span> <span class="nx">d</span><span class="p">);</span>
</code></pre></div></div>

<h3 id="データはどこ">データはどこ?</h3>

<p><em>selections.data</em>メソッドで結びついたデータはどんな形で保管されているのでしょうか。
実は、<strong>DOMの中の__data__というプロパティ</strong>に入っています。<em>selections</em>に入っているわけではありません。</p>

<p>ブラウザのDevelopper Toolで</p>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">d3</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">'circle'</span><span class="p">)</span>
</code></pre></div></div>
<p>を実行して__data__を探してみましょう。</p>

<p>これによって出力されたものが、<em>selections</em>オブジェクトの中身です。
_groups、NodeListと辿るとcircleがいくつか見られます。これがcircleのDOMです。</p>

<p><img src="./img/where_is_dom01.png" width="400px" /></p>

<p>0番目のcircleをクリックすると、DOMが持っている大量のプロパティが見られます。
下の方を見てみると、__data__が発見できます。</p>

<p><img src="./img/where_is_dom03.png" width="400px" /></p>

<p>しかしこれに直接アクセスすることは決してありません。「データを可視化する」という目的において、DOMに結ばれたデータにわざわざアクセス
することはほとんどないと思います。万が一入っているデータにアクセスしたい場合は、__data__に直接アクセスするのではなく、
<em>selection</em>.datum()もしくは<em>selections</em>.data()を引数なしで呼び出します。</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">d3</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">'circle'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">data</span><span class="p">()</span>
</code></pre></div></div>

<h3 id="データは引き継がれる">データは引き継がれる</h3>

<p>あるDOMにデータが結び付けられたとしましょう。すると、その子孫DOMにもデータが引き継がれます。
引き継ぎのタイミングは、appendやselect/selectAllが呼び出された場合です。これは非常に良い性質です。
例を示しましょう。以下は、「円の中心にテキストを出力する例」です。</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">svg</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s1">'svg'</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">g</span> <span class="o">=</span> <span class="nx">svg</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">'g'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'transform'</span><span class="p">,</span> <span class="s2">`translate(</span><span class="p">${</span><span class="nx">svgWidth</span><span class="o">/</span><span class="mi">2</span><span class="p">}</span><span class="s2">, </span><span class="p">${</span><span class="nx">svgHeight</span><span class="o">/</span><span class="mi">2</span><span class="p">}</span><span class="s2">)`</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">datum</span><span class="p">({</span><span class="na">r</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="na">name</span><span class="p">:</span> <span class="s2">"Hello"</span><span class="p">});</span>
<span class="nx">g</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">'circle'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'fill'</span><span class="p">,</span> <span class="s1">'#fff'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'stroke'</span><span class="p">,</span> <span class="s1">'#000'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'r'</span><span class="p">,</span> <span class="nx">d</span> <span class="o">=&gt;</span> <span class="nx">d</span><span class="p">.</span><span class="nx">r</span><span class="p">);</span>
<span class="nx">g</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">'text'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="nx">d</span> <span class="o">=&gt;</span> <span class="nx">d</span><span class="p">.</span><span class="nx">name</span><span class="p">);</span>
</code></pre></div></div>

<p>実行結果はこんな感じです。文字が中央に寄っていないのが嫌ですが、これについてはCase05で解決します。</p>

<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="200px" height="200px">
<g transform="translate(100, 100)"><circle fill="#fff" stroke="#000" r="10"></circle><text>Hello</text></g>
</svg>

<p>gタグの中にcircleタグとtextタグを入れ込み、gに{r: 10, name: “Hello”}という値を結びつけています。
その後appendを用いてcircleとtextを追加しています。この際に、gに結びつけた{r: 10, name: “Hello”}という
値はcircleとtextにも引き継がれます。</p>

<p>circleは{r: 10, name: “Hello”}を持っているから</p>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">g</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">'circle'</span><span class="p">)</span>
  <span class="p">...</span>
  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'r'</span><span class="p">,</span> <span class="nx">d</span> <span class="o">=&gt;</span> <span class="nx">d</span><span class="p">.</span><span class="nx">r</span><span class="p">);</span>
</code></pre></div></div>
<p>のようにして、rのを設定できるし、同様にして</p>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">g</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">'text'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="nx">d</span> <span class="o">=&gt;</span> <span class="nx">d</span><span class="p">.</span><span class="nx">name</span><span class="p">);</span>
</code></pre></div></div>
<p>のようにして、textタグのテキストを設定できるのです。</p>

<p>補足: メソッド名から何となく想像がつくと思いますが、textメソッドを用いると、タグ内部のテキストを設定できます。</p>

<h3 id="もっと詳しく知りたい方へ">もっと詳しく知りたい方へ</h3>

<p>D3.js開発者が書いている <a href="https://bost.ocks.org/mike/selection/" target="_blank">How Selections Work</a>を読みましょう。</p>

<h2 id="case-04-関数化">Case 04: 関数化</h2>

<p>今までcircleタグを書いていましたが、Case02、Case03で見たように、実際にデータ数が3個であるは限りません。
なのでcircleタグを最初から書くのをやめてしまいましょう。</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>...
<span class="nt">&lt;svg&gt;</span>
<span class="nt">&lt;/svg&gt;</span>
...
</code></pre></div></div>

<p>次のような機能を追加したいと思います。</p>

<ul>
  <li>update([4, 2, 3,…])と呼び出すと描画されるようにしたい</li>
  <li>何度も呼び出しできるようにしたい、つまり、update関数は何度も呼び出される可能性がある</li>
</ul>

<p>2つ目の要求を満たすためには、update/enter/exit全てを考慮しなければならないことがわかります。
ということで書いてみると次のようになります。データを結びつけた後に、update/enter/exitの
処理を行う、という操作を行っています。これはある種の書き方のパターンとして覚えても良いかもしれません。</p>

<p>参考: <a href="https://bl.ocks.org/mbostock/3808218" target="_blank">General Update Pattern, I</a></p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">g</span> <span class="o">=</span> <span class="nx">svg</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">'g'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'transform'</span><span class="p">,</span> <span class="s2">`translate(</span><span class="p">${</span><span class="nx">svgWidth</span><span class="o">/</span><span class="mi">2</span><span class="p">}</span><span class="s2">, </span><span class="p">${</span><span class="nx">svgHeight</span><span class="o">/</span><span class="mi">2</span><span class="p">}</span><span class="s2">)`</span><span class="p">);</span>

<span class="kd">const</span> <span class="nx">update</span> <span class="o">=</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// データを結びつける</span>
  <span class="kd">const</span> <span class="nx">circle</span> <span class="o">=</span> <span class="nx">g</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">'circle'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">data</span><span class="p">(</span><span class="nx">formatData</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">));</span>

  <span class="c1">// データと結びついたDOMを更新(update selection)</span>
  <span class="nx">circle</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'cx'</span><span class="p">,</span> <span class="nx">d</span> <span class="o">=&gt;</span> <span class="nx">d</span><span class="p">.</span><span class="nx">x</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'cy'</span><span class="p">,</span> <span class="nx">d</span> <span class="o">=&gt;</span> <span class="nx">d</span><span class="p">.</span><span class="nx">y</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'r'</span><span class="p">,</span> <span class="nx">d</span> <span class="o">=&gt;</span> <span class="nx">d</span><span class="p">.</span><span class="nx">r</span><span class="p">);</span>

  <span class="c1">// 足りなかったcircleは追加(enter selection)</span>
  <span class="kd">const</span> <span class="nx">circleEnter</span> <span class="o">=</span> <span class="nx">circle</span><span class="p">.</span><span class="nx">enter</span><span class="p">()</span>
    <span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">'circle'</span><span class="p">);</span>
  <span class="nx">circleEnter</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'cx'</span><span class="p">,</span> <span class="nx">d</span> <span class="o">=&gt;</span> <span class="nx">d</span><span class="p">.</span><span class="nx">x</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'cy'</span><span class="p">,</span> <span class="nx">d</span> <span class="o">=&gt;</span> <span class="nx">d</span><span class="p">.</span><span class="nx">y</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'r'</span><span class="p">,</span> <span class="nx">d</span> <span class="o">=&gt;</span> <span class="nx">d</span><span class="p">.</span><span class="nx">r</span><span class="p">);</span>

  <span class="c1">// 多すぎたcircleは削除(exit selection)</span>
  <span class="nx">circle</span><span class="p">.</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span>
<span class="p">};</span>
</code></pre></div></div>

<p>もしenterとupdateで設定することが同じなら、
Case02で紹介したmergeを使って、以下のように書く量を少し減らせます。</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">g</span> <span class="o">=</span> <span class="nx">svg</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">'g'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'transform'</span><span class="p">,</span> <span class="s2">`translate(</span><span class="p">${</span><span class="nx">svgWidth</span><span class="o">/</span><span class="mi">2</span><span class="p">}</span><span class="s2">, </span><span class="p">${</span><span class="nx">svgHeight</span><span class="o">/</span><span class="mi">2</span><span class="p">}</span><span class="s2">)`</span><span class="p">);</span>

<span class="kd">const</span> <span class="nx">update</span> <span class="o">=</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// データを結びつける</span>
  <span class="kd">const</span> <span class="nx">circle</span> <span class="o">=</span> <span class="nx">g</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">'circle'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">data</span><span class="p">(</span><span class="nx">formatData</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">));</span>

  <span class="c1">// 足りなかったcircleは追加(enter selection)</span>
  <span class="kd">const</span> <span class="nx">circleEnter</span> <span class="o">=</span> <span class="nx">circle</span><span class="p">.</span><span class="nx">enter</span><span class="p">()</span>
    <span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">'circle'</span><span class="p">);</span>

  <span class="c1">// update/enterをいっぺんに処理</span>
  <span class="nx">circleEnter</span><span class="p">.</span><span class="nx">merge</span><span class="p">(</span><span class="nx">circle</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'cx'</span><span class="p">,</span> <span class="nx">d</span> <span class="o">=&gt;</span> <span class="nx">d</span><span class="p">.</span><span class="nx">x</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'cy'</span><span class="p">,</span> <span class="nx">d</span> <span class="o">=&gt;</span> <span class="nx">d</span><span class="p">.</span><span class="nx">y</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'r'</span><span class="p">,</span> <span class="nx">d</span> <span class="o">=&gt;</span> <span class="nx">d</span><span class="p">.</span><span class="nx">r</span><span class="p">);</span>

  <span class="c1">// 多すぎたcircleは削除(exit selection)</span>
  <span class="nx">circle</span><span class="p">.</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span>
<span class="p">};</span>
</code></pre></div></div>

<p>Developper Toolのコンソール上で、update関数を次のように入力すると、それに応じた個数と半径の円が出力されます。</p>

<p><img src="/d3js/Part01/img/circle07.png" alt="bg contain right:50% vertical" />
<img src="/d3js/Part01/img/circle08.png" alt="bg contain" />
<img src="/d3js/Part01/img/circle09.png" alt="bg contain" /></p>

<h2 id="case-05-テキストを入れる">Case 05: テキストを入れる</h2>

<p>今度は、円の中心にデータの値が描かれるようにしてみましょう。
円とテキストを1つのグループとして扱いたいので、以下のようにgタグでくくってやります。</p>

<p><img src="/d3js/Part01/img/circle10.svg" alt="bg contain right:40%" /></p>

<p>それに応じてコード修正します。</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">update</span> <span class="o">=</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">circleGroup</span> <span class="o">=</span> <span class="nx">g</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">'g'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">data</span><span class="p">(</span><span class="nx">formatData</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">));</span>

  <span class="c1">// 足りなかった分gタグを追加</span>
  <span class="kd">const</span> <span class="nx">circleGroupEnter</span> <span class="o">=</span> <span class="nx">circleGroup</span><span class="p">.</span><span class="nx">enter</span><span class="p">()</span>
    <span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">'g'</span><span class="p">);</span>

  <span class="c1">// それぞれのgタグについて、circleタグとtextタグを追加</span>
  <span class="nx">circleGroupEnter</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">'circle'</span><span class="p">);</span>
  <span class="nx">circleGroupEnter</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">'text'</span><span class="p">);</span>

  <span class="c1">// update/exitをいっぺんに処理する</span>
  <span class="kd">const</span> <span class="nx">circleGroupMerge</span> <span class="o">=</span> <span class="nx">circleGroupEnter</span>
    <span class="p">.</span><span class="nx">merge</span><span class="p">(</span><span class="nx">circleGroup</span><span class="p">);</span>
  <span class="nx">circleGroupMerge</span>
    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'transform'</span><span class="p">,</span> <span class="nx">d</span> <span class="o">=&gt;</span> <span class="s2">`translate(</span><span class="p">${</span><span class="nx">d</span><span class="p">.</span><span class="nx">x</span><span class="p">}</span><span class="s2">, </span><span class="p">${</span><span class="nx">d</span><span class="p">.</span><span class="nx">y</span><span class="p">}</span><span class="s2">)`</span><span class="p">);</span>
  <span class="nx">circleGroupMerge</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s1">'circle'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'fill'</span><span class="p">,</span> <span class="s1">'#fff'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'stroke'</span><span class="p">,</span> <span class="s1">'#000'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'r'</span><span class="p">,</span> <span class="nx">d</span> <span class="o">=&gt;</span> <span class="nx">d</span><span class="p">.</span><span class="nx">r</span><span class="p">);</span>
  <span class="nx">circleGroupMerge</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s1">'text'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'text-anchor'</span><span class="p">,</span> <span class="s1">'middle'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'dominant-baseline'</span><span class="p">,</span> <span class="s1">'central'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="nx">d</span> <span class="o">=&gt;</span> <span class="nx">d</span><span class="p">.</span><span class="nx">val</span><span class="p">);</span>

  <span class="nx">circleGroup</span><span class="p">.</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span>
<span class="p">};</span>
</code></pre></div></div>

<p>これはsvgの知識ですが、次のような属性の設定を行うと、テキストが中央寄せになります。</p>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nx">circleGroupMerge</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s1">'text'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'text-anchor'</span><span class="p">,</span> <span class="s1">'middle'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'dominant-baseline'</span><span class="p">,</span> <span class="s1">'central'</span><span class="p">)</span>
</code></pre></div></div>

<p><img src="/d3js/Part01/img/circle11.png" alt="bg contain" /></p>

<h2 id="case-06-animation">Case 06: Animation</h2>

<p>「配列の値を円として可視化する」という意味では、十分な可視化が達成されました。
これ以降はもう少し見栄えに関する部分をいじっていきながら、d3.jsの機能に触れていきたいと思います。</p>

<p>では早速、出現や消滅をカッコよく動かしてみましょう。</p>

<h3 id="d3transition">d3.transition()</h3>

<p>DOMの属性やスタイル変更をアニメーションするためには、d3.transition()、もしくは<em>selection(s)</em>.transition()を用います。</p>

<p>例えば「円を(0,0)から(100, 120)」に移動させるといった場合、次のように書きます。
transitionを呼び出した後に変化後の属性やスタイルを設定することでアニメーションが行われます。</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">svg</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s1">'svg'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">circle</span> <span class="o">=</span> <span class="nx">svg</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">'circle'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'r'</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'cx'</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1">// 変化前のx座標</span>
  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'cy'</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="c1">// 変化前のy座標</span>
<span class="nx">circle</span><span class="p">.</span><span class="nx">transition</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'cx'</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>  <span class="c1">// 変化後のx座標</span>
  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'cy'</span><span class="p">,</span> <span class="mi">120</span><span class="p">);</span> <span class="c1">// 変化後のy座標</span>
</code></pre></div></div>

<p>遅延時間やアニメーション時間を設定したい場合は、transitionに続けてdelayやdurationを設定します。
また、複数のDOMを同期して動かしたい場合は、d3.transitionを変数として設定しておいて、
<em>selection(s)</em>.transitionの引数にそれを指定します。</p>

<p>例えば、</p>
<ul>
  <li>2つの円を500ms待機後、1000msかけて同時に動かしたい</li>
  <li>1つ目の円は(0,0)から(100,120)に移動</li>
  <li>2つ目の円は(0,0)から(150, 200)に移動</li>
</ul>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">svg</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s1">'svg'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">circle1</span> <span class="o">=</span> <span class="nx">svg</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">'circle'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'r'</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'cx'</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> 
  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'cy'</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">circle2</span> <span class="o">=</span> <span class="nx">svg</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">'circle'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'r'</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'cx'</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> 
  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'cy'</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="kd">const</span> <span class="nx">t</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">transition</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">delay</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">duration</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
<span class="nx">circle1</span><span class="p">.</span><span class="nx">transition</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'cx'</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span> 
  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'cy'</span><span class="p">,</span> <span class="mi">120</span><span class="p">);</span>
<span class="nx">circle2</span><span class="p">.</span><span class="nx">transition</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'cx'</span><span class="p">,</span> <span class="mi">150</span><span class="p">)</span> 
  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'cy'</span><span class="p">,</span> <span class="mi">200</span><span class="p">);</span>
</code></pre></div></div>

<p>ちなみにアニメーションは位置だけでなくて色や形に対しても行われます。</p>

<p>さて前置きはここまでにして、早速update関数を修正しましょう。</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">update</span> <span class="o">=</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">circleGroup</span> <span class="o">=</span> <span class="nx">g</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">'g'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">data</span><span class="p">(</span><span class="nx">formatData</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">));</span>

  <span class="c1">// 足りなかった分gタグを追加</span>
  <span class="kd">const</span> <span class="nx">circleGroupEnter</span> <span class="o">=</span> <span class="nx">circleGroup</span><span class="p">.</span><span class="nx">enter</span><span class="p">()</span>
    <span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">'g'</span><span class="p">);</span>

  <span class="c1">// それぞれのgタグについて、circleタグとtextタグを追加</span>
  <span class="nx">circleGroupEnter</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">'circle'</span><span class="p">);</span>
  <span class="nx">circleGroupEnter</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">'text'</span><span class="p">);</span>

  <span class="kd">const</span> <span class="nx">t</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">transition</span><span class="p">()</span>
    <span class="p">.</span><span class="nx">delay</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">duration</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>

  <span class="c1">// updateとenterに関するアニメーション</span>
  <span class="kd">const</span> <span class="nx">circleGroupMerge</span> <span class="o">=</span> <span class="nx">circleGroupEnter</span>
    <span class="p">.</span><span class="nx">merge</span><span class="p">(</span><span class="nx">circleGroup</span><span class="p">)</span> 
    <span class="p">.</span><span class="nx">transition</span><span class="p">(</span><span class="nx">t</span><span class="p">);</span>
  <span class="nx">circleGroupMerge</span>
    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'transform'</span><span class="p">,</span> <span class="nx">d</span> <span class="o">=&gt;</span> <span class="s2">`translate(</span><span class="p">${</span><span class="nx">d</span><span class="p">.</span><span class="nx">x</span><span class="p">}</span><span class="s2">, </span><span class="p">${</span><span class="nx">d</span><span class="p">.</span><span class="nx">y</span><span class="p">}</span><span class="s2">)`</span><span class="p">);</span>
  <span class="nx">circleGroupMerge</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s1">'circle'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'fill'</span><span class="p">,</span> <span class="s1">'#fff'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'stroke'</span><span class="p">,</span> <span class="s1">'#000'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'r'</span><span class="p">,</span> <span class="nx">d</span> <span class="o">=&gt;</span> <span class="nx">d</span><span class="p">.</span><span class="nx">r</span><span class="p">);</span>
  <span class="nx">circleGroupMerge</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s1">'text'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'text-anchor'</span><span class="p">,</span> <span class="s1">'middle'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'dominant-baseline'</span><span class="p">,</span> <span class="s1">'central'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="nx">d</span> <span class="o">=&gt;</span> <span class="nx">d</span><span class="p">.</span><span class="nx">val</span><span class="p">);</span>

  <span class="c1">// exitについては、半径を0にしてから消滅するようなアニメーションをする</span>
  <span class="kd">const</span> <span class="nx">circleGroupExit</span> <span class="o">=</span> <span class="nx">circleGroup</span><span class="p">.</span><span class="nx">exit</span><span class="p">()</span>
    <span class="p">.</span><span class="nx">transition</span><span class="p">(</span><span class="nx">t</span><span class="p">);</span>
  <span class="nx">circleGroupExit</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s1">'circle'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'r'</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
  <span class="nx">circleGroupExit</span><span class="p">.</span><span class="nx">remove</span><span class="p">();</span>
<span class="p">};</span>
</code></pre></div></div>

<p>実行結果は次のようになります。</p>

<p><img src="/d3js/Part01/img/circle12.gif" alt="bg contain" /></p>

<p>ちなみに今回はexitについて、「半径を0にしてから消滅」というアニメーションを行いましたが、
そうではなくて「だんだんと透明になって消滅」というアニメーションを行いたい場合は次のように書きます。
cssにopacityというスタイルがあるのでそれを利用します。</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="c1">// exitについては、だんだんと透明になって消滅するようなアニメーションをする</span>
  <span class="kd">const</span> <span class="nx">circleGroupExit</span> <span class="o">=</span> <span class="nx">circleGroup</span><span class="p">.</span><span class="nx">exit</span><span class="p">()</span>
    <span class="p">.</span><span class="nx">transition</span><span class="p">(</span><span class="nx">t</span><span class="p">);</span>
  <span class="nx">circleGroupExit</span><span class="p">.</span><span class="nx">style</span><span class="p">(</span><span class="s1">'opacity'</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
  <span class="nx">circleGroupExit</span><span class="p">.</span><span class="nx">remove</span><span class="p">();</span>
</code></pre></div></div>

<p>補足: 名前からなんとなく想像はつくと思いますが、
attrはタグの属性(attribute)を設定するメソッドで、styleはタグのcssスタイルを設定するメソッドです。</p>

<h2 id="case-07-relative-radius">Case 07: Relative Radius</h2>

<p>以下の図は、update([1, 30])を実行した結果です。半径を1は小さすぎだし、30は大きすぎな気がします。
そこで、半径に下限/上限を設定してあげて、小さくなりすぎない/大きくなりすぎないようにしましょう。</p>

<p><img src="/d3js/Part01/img/circle13.svg" alt="center" /></p>

<p>データを適切な半径へと拡大縮小する関数を考えましょう。
現れるデータの最大値、最小値が分かっているとして、それを$x_m, x_M$とします。
データを半径に変換する関数を作成するわけですが、半径の下限、上限をそれぞれ$y_m, y_M$とします。
半径とデータの関係ですが、「データが大きいほど半径も大きい」とします。これを満たす関数で簡単なのは一次関数です。
以上から、下図のような関数が考えられます。</p>

<p><img src="/d3js/Part01/img/func.svg" alt="bg right:50% contain" /></p>

<p>これは高校数学でお馴染みで、こんな直線の式になります。</p>

<p>\[
y = \frac{y_M - y_m}{x_M - x_m}(x - x_m) + y_m
\]</p>

<h3 id="関数を返す関数">関数を返す関数</h3>

<p>以上の軽い考察を基にして、
domainとrangeを設定すると
適切な一次関数を返してくれる関数を作ります。</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">scaleGenerator</span> <span class="o">=</span> <span class="p">(</span><span class="nx">dom</span><span class="p">,</span> <span class="nx">ran</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">x</span> <span class="o">=&gt;</span> <span class="p">(</span><span class="nx">ran</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="nx">ran</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="nx">dom</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="nx">dom</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="nx">x</span><span class="o">-</span><span class="nx">dom</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="nx">ran</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">};</span>
</code></pre></div></div>

<h3 id="動き">動き</h3>

<p>[10, 20]の範囲を線形に拡大縮小して、[30,50]の範囲に直す関数、ともみられます。
端点10、20はそれぞれ30、50に変換されます。</p>

<p><img src="img/scalegen.png" width="400px" /></p>

<h3 id="formatdataの修正">formatDataの修正</h3>

<p>Case01で書いたformatDataを修正します。引数magの代わりに、関数rScaleを指定します。</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">formatData</span> <span class="o">=</span> <span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">space</span><span class="p">,</span> <span class="nx">rScale</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">now</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kd">const</span> <span class="nx">ret</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">d</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">t</span> <span class="o">=</span> <span class="p">{</span> <span class="na">val</span><span class="p">:</span> <span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="na">r</span><span class="p">:</span> <span class="nx">rScale</span><span class="p">(</span><span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="p">]),</span> <span class="na">x</span><span class="p">:</span> <span class="nx">now</span><span class="p">,</span> <span class="na">y</span><span class="p">:</span> <span class="mi">0</span> <span class="p">};</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">data</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">now</span> <span class="o">+=</span> <span class="nx">rScale</span><span class="p">(</span><span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span> <span class="o">+</span> <span class="nx">space</span> <span class="o">+</span> <span class="nx">rScale</span><span class="p">(</span><span class="nx">data</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]);</span> 
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">t</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nx">ret</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">d</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="nx">d</span><span class="p">.</span><span class="nx">x</span> <span class="o">-=</span> <span class="nx">now</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span> <span class="p">});</span>
  <span class="k">return</span> <span class="nx">ret</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div></div>

<h3 id="updateの修正">updateの修正</h3>

<p>formatDataの修正に伴って、updateも修正します。
とりあえず半径の範囲は[10,50]で固定しました。</p>

<p>(d3.extentについては後で補足します)</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">scaleGenerator</span> <span class="o">=</span> <span class="p">(</span><span class="nx">dom</span><span class="p">,</span> <span class="nx">ran</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">x</span> <span class="o">=&gt;</span> <span class="p">(</span><span class="nx">ran</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="nx">ran</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="nx">dom</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="nx">dom</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="nx">x</span><span class="o">-</span><span class="nx">dom</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="nx">ran</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">};</span>
<span class="kd">const</span> <span class="nx">update</span> <span class="o">=</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">rScale</span> <span class="o">=</span> <span class="nx">scaleGenerator</span><span class="p">(</span><span class="nx">d3</span><span class="p">.</span><span class="nx">extent</span><span class="p">(</span><span class="nx">data</span><span class="p">),</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">50</span><span class="p">]);</span>
  <span class="kd">const</span> <span class="nx">circleGroup</span> <span class="o">=</span> <span class="nx">g</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">'g'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">data</span><span class="p">(</span><span class="nx">formatData</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="nx">rScale</span><span class="p">));</span>
  <span class="p">...</span>
<span class="p">}</span>
</code></pre></div></div>

<p><img src="/d3js/Part01/img/circle14.svg" alt="center" /></p>

<h3 id="d3scalelinear">d3.scaleLinear</h3>

<p>実は次のscaleGeneratorというのは<strong>車輪の再発明</strong>です。</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Before</span>
<span class="kd">const</span> <span class="nx">scaleGenerator</span> <span class="o">=</span> <span class="p">(</span><span class="nx">dom</span><span class="p">,</span> <span class="nx">ran</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">x</span> <span class="o">=&gt;</span> <span class="p">(</span><span class="nx">ran</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="nx">ran</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="nx">dom</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="nx">dom</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="nx">x</span><span class="o">-</span><span class="nx">dom</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="nx">ran</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">};</span>
<span class="kd">const</span> <span class="nx">rScale</span> <span class="o">=</span> <span class="nx">scaleGenerator</span><span class="p">(</span><span class="nx">d3</span><span class="p">.</span><span class="nx">extent</span><span class="p">(</span><span class="nx">data</span><span class="p">),</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">50</span><span class="p">]);</span>
</code></pre></div></div>

<p>d3.jsには同じ機能を持った関数scaleLinearがあります。使い方は下記のようにします。
次からはこれを使いましょう。</p>

<p>scaleLinearには今回作ったscaleGeneratorより優れている点があるのですが、詳しくはCase08-3で説明します。</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// After</span>
<span class="kd">const</span> <span class="nx">rScale</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">scaleLinear</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">domain</span><span class="p">(</span><span class="nx">d3</span><span class="p">.</span><span class="nx">extent</span><span class="p">(</span><span class="nx">data</span><span class="p">))</span>
  <span class="p">.</span><span class="nx">range</span><span class="p">([</span><span class="mi">10</span><span class="p">,</span> <span class="mi">50</span><span class="p">]);</span>
</code></pre></div></div>

<p>今回は一次関数を用いてデータを拡大縮小しました。他にも、scalePos/scaleLog/scaleSqrtなどを用いて、一次関数以外の変換も可能です。</p>

<h3 id="補足-maxminextent">補足: max/min/extent</h3>

<p>d3.jsには便利な関数max/min/extentが用意されています。max/minはそれぞれデータの最大値を返します。
extentはデータの範囲を[最小値,最大値]の形式で返します。</p>

<p><img src="img/maxmin.png" width="400px" /></p>

<p>要素がObject/Arrayだった場合は、次のように第2引数に関数を書くことで、何に対しての最大値/最小なのかを指定できます。</p>

<p><img src="img/maxmin2.png" width="400px" /></p>

<p>他にも便利な配列操作系関数が用意されています。どんなものがあるかは<a href="https://github.com/d3/d3-array" target="_blank">d3/d3-array</a>
を参考にしてください。</p>

<h2 id="case-08-color">Case 08: Color</h2>

<p>今度は色をつけてみましょう。以下の3つのケースについて説明していきます。</p>
<ol>
  <li>色をランダムにする</li>
  <li>初めから用意せれた色を用いる</li>
  <li>データの大きさに応じた色にする</li>
</ol>

<h2 id="case-08-1-random-color">Case 08-1: Random Color</h2>

<p>色をランダムにしましょう。fill属性などにおける色指定ではrgbを指定できるので、
rbgにおける3つの値それぞれにおいて0から255までの整数値についての乱数を作成することを考えます。</p>

<h3 id="d3randomuniform">d3.randomUniform</h3>

<p>一様分布を生成する関数を作成する関数にd3.randomUniformというものがあります。
範囲は右半開区間で指定して、例えば[10, 20)の範囲の乱数を生成する関数は次のように書けます。</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">rand</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">randomUniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">20</span><span class="p">);</span>
</code></pre></div></div>

<p>実際に乱数を生成するときはrand()を呼び出します。</p>

<p><img src="img/rand.png" width="400px" /></p>

<p>randonUniformで生成される乱数は実数値です。今回はrgbが整数値である必要があるので、整数値に丸めなければいけません。
そこで、randomUniformをラッピングして、乱数生成器randomIntを作成します。</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">randomInt</span> <span class="o">=</span> <span class="p">(</span><span class="nx">m</span><span class="p">,</span> <span class="nx">M</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">randUniform</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">randomUniform</span><span class="p">(</span><span class="nx">m</span><span class="p">,</span> <span class="nx">M</span><span class="p">);</span>
  <span class="k">return</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">randUniform</span><span class="p">());</span>
<span class="p">};</span>
</code></pre></div></div>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">update</span> <span class="o">=</span> <span class="p">(</span><span class="nx">date</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="p">...</span>
  <span class="kd">const</span> <span class="nx">randomInt</span> <span class="o">=</span> <span class="p">(</span><span class="nx">m</span><span class="p">,</span> <span class="nx">M</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">randUniform</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">randomUniform</span><span class="p">(</span><span class="nx">m</span><span class="p">,</span> <span class="nx">M</span><span class="p">);</span>
    <span class="k">return</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">randUniform</span><span class="p">());</span>
  <span class="p">};</span>

  <span class="kd">const</span> <span class="nx">rand</span> <span class="o">=</span> <span class="nx">randomInt</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">256</span><span class="p">);</span>
  <span class="nx">circleGroupMerge</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s1">'circle'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'fill'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="s2">`rgb(</span><span class="p">${</span><span class="nx">rand</span><span class="p">()}</span><span class="s2">, </span><span class="p">${</span><span class="nx">rand</span><span class="p">()}</span><span class="s2">, </span><span class="p">${</span><span class="nx">rand</span><span class="p">()}</span><span class="s2">)`</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'stroke'</span><span class="p">,</span> <span class="s1">'#000'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'r'</span><span class="p">,</span> <span class="nx">d</span> <span class="o">=&gt;</span> <span class="nx">d</span><span class="p">.</span><span class="nx">r</span><span class="p">);</span>
  <span class="p">...</span>
<span class="p">}</span>
</code></pre></div></div>

<p>実は、randomIntは車輪の再発明です。
d3-randomのscriptファイルを読み込めば、これと同等の機能を持つ関数d3.randomIntが利用できます。
また、今回一様分布乱数を利用しましたが、他にも正規分布や二項分布の乱数も用意されています。
詳しくは<a href="https://github.com/d3/d3-random">d3-random</a>のページを参照してください。</p>

<h3 id="若干汚いことがある">若干汚い(ことがある)</h3>

<p>実行してみると、汚い色が現れることがよくあります。</p>

<p><img src="/d3js/Part01/img/circle15.svg" alt="" /></p>

<p>rgb値それぞれについて乱数を設定すると、どうしても汚い色が現れます。
hslで考えれば色の鮮やかさを固定できるので、hslを利用して色を設定してみましょう。</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">update</span> <span class="o">=</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="p">...</span>
  <span class="kd">const</span> <span class="nx">rand</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">randomUniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span><span class="p">);</span>
  <span class="nx">circleGroupMerge</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s1">'circle'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'fill'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="s2">`hsl(</span><span class="p">${</span><span class="nx">rand</span><span class="p">()}</span><span class="s2">rad, 100%, 50%)`</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'stroke'</span><span class="p">,</span> <span class="s1">'#000'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'r'</span><span class="p">,</span> <span class="nx">d</span> <span class="o">=&gt;</span> <span class="nx">rScale</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">val</span><span class="p">));</span>
  <span class="p">...</span>
<span class="p">};</span>
</code></pre></div></div>

<p><img src="/d3js/Part01/img/circle_hsl.svg" alt="" /></p>

<h2 id="case-08-2-color-scheme">Case 08-2: Color Scheme</h2>

<p>あらかじめ用意された色セットを使ってみましょう。どんなものがあるかは
<a href="https://github.com/d3/d3-scale-chromatic" target="_blank">d3-scale-chromatic</a>
を参考にしてください。
さて、その中の1つであるd3.schemeSet1を見てみると、どうやら色の配列のようです。</p>

<p><img src="img/schemeSet1.png" width="400px" /></p>

<p>この色セットから色をランダムに選ぶようにしてみましょう。</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">update</span> <span class="o">=</span> <span class="p">(</span><span class="nx">date</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="p">...</span>
  <span class="kd">const</span> <span class="nx">randomInt</span> <span class="o">=</span> <span class="p">(</span><span class="nx">m</span><span class="p">,</span> <span class="nx">M</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">randUniform</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">randomUniform</span><span class="p">(</span><span class="nx">m</span><span class="p">,</span> <span class="nx">M</span><span class="p">);</span>
    <span class="k">return</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">randUniform</span><span class="p">());</span>
  <span class="p">};</span>

  <span class="kd">const</span> <span class="nx">rand</span> <span class="o">=</span> <span class="nx">randomInt</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">schemeSet1</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
  <span class="nx">circleGroupMerge</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s1">'circle'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'fill'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">schemeSet1</span><span class="p">[</span><span class="nx">rand</span><span class="p">()])</span>
    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'stroke'</span><span class="p">,</span> <span class="s1">'#000'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'r'</span><span class="p">,</span> <span class="nx">d</span> <span class="o">=&gt;</span> <span class="nx">d</span><span class="p">.</span><span class="nx">r</span><span class="p">);</span>
  <span class="p">...</span>
<span class="p">};</span>
</code></pre></div></div>

<p><img src="/d3js/Part01/img/circle16.svg" alt="center" /></p>

<p>グラデーションのColor Schemeもあります。
詳しくは<a href="https://github.com/d3/d3-scale-chromatic" target="_blank">d3-scale-chromatic</a>
を参考にしてください。</p>

<h2 id="case-08-3-linear-color-scale">Case 08-3: Linear Color Scale</h2>

<p>値に応じて色が決まるようにしましょう。具体的には、</p>

<ul>
  <li>値: 小 ⇔ 中 ⇔ 大</li>
  <li>色: 水 ⇔ 白 ⇔ 橙</li>
</ul>

<p>のように対応させることを考えます。</p>

<h3 id="d3scalelinear再び">d3.scaleLinear再び</h3>

<p>驚くべきことに、値と色を対応させる目的でscaleLinearが使えます。
さらに、domain/rangeに中間の値を設定することができます。</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">colorScale</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">scaleLinear</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">domain</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">])</span>
  <span class="p">.</span><span class="nx">range</span><span class="p">([</span><span class="s1">'orangered'</span><span class="p">,</span> <span class="s1">'white'</span><span class="p">,</span> <span class="s1">'skyblue'</span><span class="p">]);</span>
</code></pre></div></div>

<p><img src="img/colorscale.png" width="400px" /></p>

<p>これを利用してupdate関数を修正します。</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">update</span> <span class="o">=</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="p">...</span>
  <span class="kd">const</span> <span class="p">[</span><span class="nx">rmin</span><span class="p">,</span> <span class="nx">rmax</span><span class="p">]</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">extent</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
  <span class="kd">const</span> <span class="nx">colorScale</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">scaleLinear</span><span class="p">()</span>
    <span class="p">.</span><span class="nx">domain</span><span class="p">([</span><span class="nx">rmin</span><span class="p">,</span> <span class="p">(</span><span class="nx">rmin</span> <span class="o">+</span> <span class="nx">rmax</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="nx">rmax</span><span class="p">])</span>
    <span class="p">.</span><span class="nx">range</span><span class="p">([</span><span class="s1">'orangered'</span><span class="p">,</span> <span class="s1">'white'</span><span class="p">,</span> <span class="s1">'skyblue'</span><span class="p">]);</span>
  <span class="nx">circleGroupMerge</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s1">'circle'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'fill'</span><span class="p">,</span> <span class="nx">d</span> <span class="o">=&gt;</span> <span class="nx">colorScale</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">val</span><span class="p">))</span>
    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'stroke'</span><span class="p">,</span> <span class="s1">'#000'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'r'</span><span class="p">,</span> <span class="nx">d</span> <span class="o">=&gt;</span> <span class="nx">d</span><span class="p">.</span><span class="nx">r</span><span class="p">);</span>
  <span class="p">...</span>
<span class="p">};</span>
</code></pre></div></div>

<p><img src="/d3js/Part01/img/circle17.svg" alt="center" /></p>

<h2 id="case-09-click">Case 09: Click</h2>

<p>今度は、「クリックされたボールは1増加させる」という処理を考えてみましょう。
ただここでは、1増加させたらそれに同期して元データも1増加させることを考えます。</p>

<h3 id="2つの方法">2つの方法</h3>

<p>これを実現するには、2つの方法がありそうです。ここでは、以下のように名前をつけたいと思います。</p>

<ol>
  <li>Rebind - データを再度結びつけ直す</li>
  <li>Update Directly - DOMに結ばれたデータの値を直接変更</li>
</ol>

<h3 id="common-comcept-selectionon">Common Comcept: <em>selection</em>.on</h3>

<p>どちらの方法にしても、<em>selection</em>.onメソッドを用います。第一引数にイベント名を指定し、第二引数にイベント発生時の処理を書きます。
例えば、「circleがクリックされたらアラートを出す」という処理は以下のように書けます。</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">svg</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s1">'svg'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">circle</span> <span class="o">=</span> <span class="nx">svg</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">'circle'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">datum</span><span class="p">(</span><span class="s2">"Hello"</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'cx'</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'cy'</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'r'</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'click'</span><span class="p">,</span> <span class="nx">d</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">alert</span><span class="p">(</span><span class="nx">d</span><span class="p">);</span>
  <span class="p">});</span>
</code></pre></div></div>

<h3 id="1st-method-rebind">1st Method: Rebind</h3>

<p>結びついたデータが元のデータ配列の何番目なのかを知りたいので、dataに自分の番号を持たせましょう。
その番号を通じて、データの値を変更します。
「番号は次のコールバック関数のiを用いれば良いじゃないか」と思われるかもしれません。</p>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">...</span>
<span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'click'</span><span class="p">,</span> <span class="p">(</span><span class="nx">d</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="p">...</span> <span class="p">});</span>
</code></pre></div></div>
<p>今回のケースではこれでも正しく動きますが、一般に元データの順番と結びつけられたデータの順番が一緒とは限りません。
dataメソッドにキーを指定していしてデータを結びつける方法があるからです。
これについては
<a href="https://github.com/d3/d3-selection/blob/v1.4.0/README.md#selection_data" target="_blank">
How Selections WorkのThe Key to Enligntenment</a>
や
<a href="https://bl.ocks.org/mbostock/3808221" target="_blank">Genera Update Pattern, II</a>
<a href="https://github.com/d3/d3-selection/blob/v1.4.0/README.md#selection_data" target="_blank">selection.data</a>
に解説を委ねるとして、とにかく番号をdataにもたせます。formatDataを以下のように修正しましょう。</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">formatData</span> <span class="o">=</span> <span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">space</span><span class="p">,</span> <span class="nx">rScale</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">now</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kd">const</span> <span class="nx">ret</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">d</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">t</span> <span class="o">=</span> <span class="p">{</span> 
      <span class="na">idx</span><span class="p">:</span> <span class="nx">i</span><span class="p">,</span> <span class="na">val</span><span class="p">:</span> <span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="na">r</span><span class="p">:</span> <span class="nx">rScale</span><span class="p">(</span><span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="p">]),</span>
      <span class="na">x</span><span class="p">:</span> <span class="nx">now</span><span class="p">,</span> <span class="na">y</span><span class="p">:</span> <span class="mi">0</span>
    <span class="p">};</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">data</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">now</span> <span class="o">+=</span> <span class="nx">rScale</span><span class="p">(</span><span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span> <span class="o">+</span> <span class="nx">space</span> <span class="o">+</span> <span class="nx">rScale</span><span class="p">(</span><span class="nx">data</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]);</span> 
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="nx">ret</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">d</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="nx">d</span><span class="p">.</span><span class="nx">x</span> <span class="o">-=</span> <span class="nx">now</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span> <span class="p">});</span>
  <span class="k">return</span> <span class="nx">ret</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div></div>

<p>次に、update関数の修正をします。
transition付きにはonclickが設定できないので
circleGroupMergeとtransitionを、新たにcircleGroupTransitionとして分離します。</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">update</span> <span class="o">=</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="p">...</span>
  <span class="kd">const</span> <span class="nx">circleGroupMerge</span> <span class="o">=</span> <span class="nx">circleGroupEnter</span>
    <span class="p">.</span><span class="nx">merge</span><span class="p">(</span><span class="nx">circleGroup</span><span class="p">);</span>
  <span class="kd">const</span> <span class="nx">circleGroupTrans</span> <span class="o">=</span> <span class="nx">circleGroupMerge</span><span class="p">.</span><span class="nx">transition</span><span class="p">(</span><span class="nx">t</span><span class="p">);</span>
  <span class="nx">circleGroupTrans</span>
    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'transform'</span><span class="p">,</span> <span class="nx">d</span> <span class="o">=&gt;</span> <span class="s2">`translate(</span><span class="p">${</span><span class="nx">d</span><span class="p">.</span><span class="nx">x</span><span class="p">}</span><span class="s2">, </span><span class="p">${</span><span class="nx">d</span><span class="p">.</span><span class="nx">y</span><span class="p">}</span><span class="s2">)`</span><span class="p">);</span>

  <span class="kd">const</span> <span class="p">[</span><span class="nx">rmin</span><span class="p">,</span> <span class="nx">rmax</span><span class="p">]</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">extent</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">d</span> <span class="o">=&gt;</span> <span class="nx">d</span><span class="p">.</span><span class="nx">val</span><span class="p">);</span>
  <span class="kd">const</span> <span class="nx">colorScale</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">scaleLinear</span><span class="p">()</span>
    <span class="p">.</span><span class="nx">domain</span><span class="p">([</span><span class="nx">rmin</span><span class="p">,</span> <span class="p">(</span><span class="nx">rmin</span> <span class="o">+</span> <span class="nx">rmax</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="nx">rmax</span><span class="p">])</span>
    <span class="p">.</span><span class="nx">range</span><span class="p">([</span><span class="s1">'orangered'</span><span class="p">,</span> <span class="s1">'white'</span><span class="p">,</span> <span class="s1">'skyblue'</span><span class="p">]);</span>
  <span class="nx">circleGroupTrans</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s1">'circle'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'fill'</span><span class="p">,</span> <span class="nx">d</span> <span class="o">=&gt;</span> <span class="nx">colorScale</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">val</span><span class="p">))</span>
    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'stroke'</span><span class="p">,</span> <span class="s1">'#000'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'r'</span><span class="p">,</span> <span class="nx">d</span> <span class="o">=&gt;</span> <span class="nx">d</span><span class="p">.</span><span class="nx">r</span><span class="p">);</span>
  <span class="nx">circleGroupTrans</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s1">'text'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'text-anchor'</span><span class="p">,</span> <span class="s1">'middle'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'dominant-baseline'</span><span class="p">,</span> <span class="s1">'central'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="nx">d</span> <span class="o">=&gt;</span> <span class="nx">d</span><span class="p">.</span><span class="nx">val</span><span class="p">);</span>

  <span class="c1">// クリックされた場合、dataを変更してupdate関数を呼び出す</span>
  <span class="nx">circleGroupMerge</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'click'</span><span class="p">,</span> <span class="nx">d</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">data</span><span class="p">[</span><span class="nx">d</span><span class="p">.</span><span class="nx">idx</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
    <span class="nx">update</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
  <span class="p">});</span>
  <span class="p">...</span>
<span class="p">};</span>
</code></pre></div></div>

<h3 id="2nd-method-update-directly">2nd Method: Update Directly</h3>

<p>1st Mathodと同じように、次のように書いてもうまくいきません。</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">circleGroupMerge</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'click'</span><span class="p">,</span> <span class="nx">d</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">d</span><span class="p">.</span><span class="nx">val</span><span class="o">++</span><span class="p">;</span>
  <span class="nx">update</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div></div>

<p>確かにDOMに結びつけられたデータは1加えられるのですが、dataそのものは無変更です。
結局、update(data)によって、変更したデータは無かったことになってしまいます。</p>

<p>そうすると、</p>

<ul>
  <li><strong>データを追加/削除する処理</strong></li>
  <li><strong>circleの状態を変更する処理</strong></li>
</ul>

<p>を分けたくなってきます。
次にように、コールバック関数の中で属性の変更をすることができなくもないのですが、
少し冗長です。</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">circleGroupMerge</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'click'</span><span class="p">,</span> <span class="nx">d</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">d</span><span class="p">.</span><span class="nx">val</span><span class="o">++</span><span class="p">;</span>
  <span class="nx">circleGroupMerge</span>
    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'transform'</span><span class="p">,</span> <span class="nx">d</span> <span class="o">=&gt;</span> <span class="s2">`translate(</span><span class="p">${</span><span class="nx">d</span><span class="p">.</span><span class="nx">x</span><span class="p">}</span><span class="s2">, </span><span class="p">${</span><span class="nx">d</span><span class="p">.</span><span class="nx">y</span><span class="p">}</span><span class="s2">)`</span><span class="p">);</span>
  <span class="nx">circleGroupMerge</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s1">'circle'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'fill'</span><span class="p">,</span> <span class="nx">d</span> <span class="o">=&gt;</span> <span class="nx">colorScale</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">val</span><span class="p">))</span>
    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'stroke'</span><span class="p">,</span> <span class="s1">'#000'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'r'</span><span class="p">,</span> <span class="nx">d</span> <span class="o">=&gt;</span> <span class="nx">rScale</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">val</span><span class="p">));</span>
  <span class="nx">circleGroupMerge</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s1">'text'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'text-anchor'</span><span class="p">,</span> <span class="s1">'middle'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'dominant-baseline'</span><span class="p">,</span> <span class="s1">'central'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="nx">d</span> <span class="o">=&gt;</span> <span class="nx">d</span><span class="p">.</span><span class="nx">val</span><span class="p">);</span>
  <span class="nx">circleGroupMerge</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s1">'text'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'text-anchor'</span><span class="p">,</span> <span class="s1">'middle'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'dominant-baseline'</span><span class="p">,</span> <span class="s1">'central'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="nx">d</span> <span class="o">=&gt;</span> <span class="nx">d</span><span class="p">.</span><span class="nx">val</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div></div>

<p>そこで、大胆にがらっとコードを書き換えることを考えます。</p>

<h4 id="機能分離">機能分離</h4>

<p>次のように関数を設計します。</p>

<ul>
  <li>formatData: データに位置や半径の情報を付加する</li>
  <li>calcCircleInfo: 位置や半径の情報を更新する</li>
  <li>adjustCirclesByData: データに応じてDOMの個数を調整する</li>
  <li>decorateCircles: データのattr/style変更をする</li>
  <li>update: update(普通の配列)としてアクセスするための関数</li>
</ul>

<h4 id="formatdata">formatData</h4>

<p>位置や半径の実際の値についてはcalcCircleInfoで決定するとして、とりあえずテンプレだけ作って返す関数です。</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">formatData</span> <span class="o">=</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">ret</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">data</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">ret</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
      <span class="na">val</span><span class="p">:</span> <span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span>
      <span class="na">x</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
      <span class="na">y</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
      <span class="na">r</span><span class="p">:</span> <span class="mi">0</span>
    <span class="p">});</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">ret</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div></div>

<h4 id="calccircleinfo">calcCircleInfo</h4>

<p>位置や半径を更新します。</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">calcCircleInfo</span> <span class="o">=</span> <span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">space</span><span class="p">,</span> <span class="nx">rScale</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">now</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="nx">data</span><span class="p">.</span><span class="nx">forEach</span><span class="p">((</span><span class="nx">d</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">d</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="nx">now</span><span class="p">;</span>
    <span class="nx">d</span><span class="p">.</span><span class="nx">r</span> <span class="o">=</span> <span class="nx">rScale</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">val</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">data</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">now</span> <span class="o">+=</span> <span class="nx">rScale</span><span class="p">(</span><span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">val</span><span class="p">)</span> <span class="o">+</span> <span class="nx">space</span> <span class="o">+</span> <span class="nx">rScale</span><span class="p">(</span><span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="p">].</span><span class="nx">val</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">});</span>
  <span class="nx">data</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">d</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="nx">d</span><span class="p">.</span><span class="nx">x</span> <span class="o">-=</span> <span class="nx">now</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span> <span class="p">});</span>
  <span class="k">return</span> <span class="nx">data</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div></div>

<h4 id="adjustcirclesbydata">adjustCirclesByData</h4>

<p>とりあえずDOMの個数の追加/削除だけを行い、位置、色、半径などの設定はdecorateCirclesに処理を投げます。</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">adjustCirclesByData</span> <span class="o">=</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">circleGroup</span> <span class="o">=</span> <span class="nx">g</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">'g'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">data</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
  <span class="kd">const</span> <span class="nx">circleGroupEnter</span> <span class="o">=</span> <span class="nx">circleGroup</span><span class="p">.</span><span class="nx">enter</span><span class="p">()</span>
    <span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">'g'</span><span class="p">)</span>
  <span class="nx">circleGroupEnter</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">'circle'</span><span class="p">);</span>
  <span class="nx">circleGroupEnter</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">'text'</span><span class="p">);</span>

  <span class="kd">const</span> <span class="nx">circleGroupMerge</span> <span class="o">=</span> <span class="nx">circleGroupEnter</span>
    <span class="p">.</span><span class="nx">merge</span><span class="p">(</span><span class="nx">circleGroup</span><span class="p">);</span>
  <span class="nx">decorateCircles</span><span class="p">(</span><span class="nx">circleGroupMerge</span><span class="p">);</span>

  <span class="kd">const</span> <span class="nx">circleGroupExit</span> <span class="o">=</span> <span class="nx">circleGroup</span><span class="p">.</span><span class="nx">exit</span><span class="p">()</span>
    <span class="p">.</span><span class="nx">transition</span><span class="p">()</span>
    <span class="p">.</span><span class="nx">delay</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">duration</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
  <span class="nx">circleGroupExit</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s1">'circle'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'r'</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
  <span class="nx">circleGroupExit</span><span class="p">.</span><span class="nx">remove</span><span class="p">();</span>

  <span class="nx">circleGroupMerge</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'click'</span><span class="p">,</span> <span class="nx">d</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">d</span><span class="p">.</span><span class="nx">val</span><span class="o">++</span><span class="p">;</span>
      <span class="nx">decorateCircles</span><span class="p">(</span><span class="nx">circleGroupMerge</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">};</span>
</code></pre></div></div>

<h4 id="decoratecircles">decorateCircles</h4>

<p><em>selection</em> を引数にとる少し奇妙な関数です。<em>selection</em>に対応するDOMの属性を変更します。</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">decorateCircles</span> <span class="o">=</span> <span class="p">(</span><span class="nx">circleGroup</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">circleGroup</span><span class="p">.</span><span class="nx">data</span><span class="p">();</span>
  <span class="kd">const</span> <span class="nx">rScale</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">scaleLinear</span><span class="p">()</span>
    <span class="p">.</span><span class="nx">domain</span><span class="p">(</span><span class="nx">d3</span><span class="p">.</span><span class="nx">extent</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">d</span> <span class="o">=&gt;</span> <span class="nx">d</span><span class="p">.</span><span class="nx">val</span><span class="p">))</span>
    <span class="p">.</span><span class="nx">range</span><span class="p">([</span><span class="mi">10</span><span class="p">,</span> <span class="mi">50</span><span class="p">]);</span>
  <span class="nx">calcCircleInfo</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="nx">rScale</span><span class="p">);</span>
  <span class="kd">const</span> <span class="p">[</span><span class="nx">rmin</span><span class="p">,</span> <span class="nx">rmax</span><span class="p">]</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">extent</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">d</span> <span class="o">=&gt;</span> <span class="nx">d</span><span class="p">.</span><span class="nx">val</span><span class="p">);</span>
  <span class="kd">const</span> <span class="nx">colorScale</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">scaleLinear</span><span class="p">()</span>
    <span class="p">.</span><span class="nx">domain</span><span class="p">([</span><span class="nx">rmin</span><span class="p">,</span> <span class="p">(</span><span class="nx">rmin</span> <span class="o">+</span> <span class="nx">rmax</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="nx">rmax</span><span class="p">])</span>
    <span class="p">.</span><span class="nx">range</span><span class="p">([</span><span class="s1">'skyblue'</span><span class="p">,</span> <span class="s1">'white'</span><span class="p">,</span> <span class="s1">'orangered'</span><span class="p">]);</span>
  <span class="kd">const</span> <span class="nx">circleGroupTrans</span> <span class="o">=</span> <span class="nx">circleGroup</span>
    <span class="p">.</span><span class="nx">transition</span><span class="p">()</span>
    <span class="p">.</span><span class="nx">delay</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">duration</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>

  <span class="nx">circleGroupTrans</span>
    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'transform'</span><span class="p">,</span> <span class="nx">d</span> <span class="o">=&gt;</span> <span class="s2">`translate(</span><span class="p">${</span><span class="nx">d</span><span class="p">.</span><span class="nx">x</span><span class="p">}</span><span class="s2">, </span><span class="p">${</span><span class="nx">d</span><span class="p">.</span><span class="nx">y</span><span class="p">}</span><span class="s2">)`</span><span class="p">);</span>
  <span class="nx">circleGroupTrans</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s1">'circle'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'fill'</span><span class="p">,</span> <span class="nx">d</span> <span class="o">=&gt;</span> <span class="nx">colorScale</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">val</span><span class="p">))</span>
    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'stroke'</span><span class="p">,</span> <span class="s1">'#000'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'r'</span><span class="p">,</span> <span class="nx">d</span> <span class="o">=&gt;</span> <span class="nx">d</span><span class="p">.</span><span class="nx">r</span><span class="p">);</span>
  <span class="nx">circleGroupTrans</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s1">'text'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'text-anchor'</span><span class="p">,</span> <span class="s1">'middle'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'dominant-baseline'</span><span class="p">,</span> <span class="s1">'central'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="nx">d</span> <span class="o">=&gt;</span> <span class="nx">d</span><span class="p">.</span><span class="nx">val</span><span class="p">);</span>
<span class="p">};</span>
</code></pre></div></div>

<h4 id="update">update</h4>

<p>formatDataでデータを適当な形に変換したものに対して
adjustCirclesByDataを適用します。</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">update</span> <span class="o">=</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">adjustCirclesByData</span><span class="p">(</span><span class="nx">formatData</span><span class="p">(</span><span class="nx">data</span><span class="p">));</span>
<span class="p">};</span>
</code></pre></div></div>

<p>これでなんとかうまくいきます。</p>

<p><img src="/d3js/Part01/img/circle18.gif" alt="bg contain" /></p>

<h3 id="注意">注意</h3>

<p>このように、データを可視化して、インタラクティブに触れることができるようになりました。
ただし、D3.jsはデータ可視化のためのライブラリなので、「データを書き換える」ということは本来の使い方でないことを心に留めておきましょう。</p>

<h3 id="interactive-process">Interactive Process</h3>

<p><em>selection</em>.onを用いたインタラクティブ処理の応用例としては、次の二つの処理に分かれると思います。</p>

<ol>
  <li>データ書き換え以外のインタラクティブ要素<br />
ex) マウスを乗せると座標が表示される</li>
  <li><strong>データの動きを見たい</strong></li>
</ol>

<p>今後のチュートリアルで扱うのは主に2です。
例えば、「迷路を探索する様子を見たい」という要求に応えるようにするためには、
マップとその探索情報を少しずつ進めながら可視化する必要があります。</p>

<p><img src="img/maze.gif" width="400px" /></p>

<p>これは、紹介した2つの方法どちらでも実現することが可能です。
2つの特徴を以下に挙げます。</p>

<h4 id="1st-method-rebind-1">1st Method: Rebind</h4>

<ul>
  <li>実装楽</li>
  <li>用意すべきデータが2stに比べ多い</li>
</ul>

<h4 id="2nd-method-update-directly-1">2nd Method: Update Directly</h4>

<ul>
  <li>差分だけ更新
⇒ 用意すべきデータが1stに比べ少ない</li>
  <li>データの持たせ方が難しい時がある</li>
</ul>

<h2 id="case-10-input-area">Case 10: Input Area</h2>

<p>下図のように、入力エリアを作ってみましょう。
入力形式は自由に決めて良いですが、ここでは以下のような制約とします。</p>
<ul>
  <li>スペース区切りで数字が入力される</li>
  <li>複数行入力も受け付ける</li>
</ul>

<p><img src="/d3js/Part01/img/layout.png" alt="center w:900px" /></p>

<h3 id="indexhtml">index.html</h3>

<p>divでくくって、その中にメニューとメインコンテンツを配置するようなレイアウトにします。</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>...
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"main-container"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"menu"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"main"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;svg&gt;</span>
    <span class="nt">&lt;/svg&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
...
</code></pre></div></div>

<h3 id="stylecss">style.css</h3>

<p>flexレイアウトを用いることで、横並びのレイアウトにします。</p>

<div class="language-css highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">.main-container</span> <span class="p">{</span>
  <span class="nl">display</span><span class="p">:</span> <span class="n">flex</span><span class="p">;</span>
  <span class="nl">flex-direction</span><span class="p">:</span> <span class="n">row</span><span class="p">;</span>
<span class="p">}</span>
<span class="nc">.menu</span> <span class="p">{</span>
  <span class="nl">display</span><span class="p">:</span> <span class="n">flex</span><span class="p">;</span>
  <span class="nl">flex-direction</span><span class="p">:</span> <span class="n">column</span><span class="p">;</span>
<span class="p">}</span>
<span class="nt">svg</span> <span class="p">{</span>
  <span class="nl">border</span><span class="p">:</span> <span class="m">1px</span> <span class="nb">solid</span> <span class="m">#000</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="scriptjs">script.js</h3>

<p>以下のように追加します。</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">...</span>

<span class="kd">const</span> <span class="nx">menu</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s1">'.menu'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">textarea</span> <span class="o">=</span> <span class="nx">menu</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">'textarea'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">style</span><span class="p">(</span><span class="s1">'height'</span><span class="p">,</span> <span class="s2">`</span><span class="p">${</span><span class="nx">svgHeight</span> <span class="o">-</span> <span class="mi">30</span><span class="p">}</span><span class="s2">px`</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">genButton</span> <span class="o">=</span> <span class="nx">menu</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">'input'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'height'</span><span class="p">,</span> <span class="s1">'30px'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'type'</span><span class="p">,</span> <span class="s1">'button'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'value'</span><span class="p">,</span> <span class="s1">'generate'</span><span class="p">);</span>

<span class="nx">genButton</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'click'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">input</span> <span class="o">=</span> <span class="nx">textarea</span><span class="p">.</span><span class="nx">property</span><span class="p">(</span><span class="s1">'value'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">'</span><span class="err">\</span><span class="s1">n'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">d</span> <span class="o">=&gt;</span> <span class="nx">d</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">' '</span><span class="p">));</span>
  <span class="kd">const</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">merge</span><span class="p">(</span><span class="nx">input</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">d</span> <span class="o">=&gt;</span> <span class="nb">Number</span><span class="p">(</span><span class="nx">d</span><span class="p">));</span>
  <span class="nx">update</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div></div>

<p>なにやら見慣れないメソッドがありますが、以下の点に注目してください。</p>

<ul>
  <li>textarea.property(‘value’)でテキストエリアの内容を取得</li>
  <li>d3.merge([1], [2, 3], [4, 5]) → [1, 2, 3, 4, 5]</li>
  <li>Nubmer(d)でdを数値に変換</li>
</ul>

<h3 id="case-11-random-numbers">Case 11: Random Numbers</h3>

<p>入力エリアでいちいち入力するのが面倒かと思うかもしれません。
ランダムに数列を生成してくれる機能を作りましょう。</p>

<p>今回は、「0から9までの乱数を7個生成する」ことにします。
script.jsに以下の文を追加します。</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">randButton</span> <span class="o">=</span> <span class="nx">menu</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">'input'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'height'</span><span class="p">,</span> <span class="s1">'30px'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'type'</span><span class="p">,</span> <span class="s1">'button'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'value'</span><span class="p">,</span> <span class="s1">'random'</span><span class="p">);</span>

<span class="nx">randButton</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'click'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">randomInt</span> <span class="o">=</span> <span class="p">(</span><span class="nx">m</span><span class="p">,</span> <span class="nx">M</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">randomUniform</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">randomUniform</span><span class="p">(</span><span class="nx">m</span><span class="p">,</span> <span class="nx">M</span><span class="p">);</span>
    <span class="k">return</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">randomUniform</span><span class="p">());</span>
  <span class="p">}</span>
  <span class="kd">const</span> <span class="nx">rand</span> <span class="o">=</span> <span class="nx">randomInt</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
  <span class="kd">const</span> <span class="nx">data</span> <span class="o">=</span> <span class="p">[...</span><span class="nb">Array</span><span class="p">(</span><span class="mi">7</span><span class="p">)].</span><span class="nx">map</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="nx">rand</span><span class="p">());</span>
  <span class="nx">update</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div></div>

<p><img src="img/circle_random.gif" /></p>

<h2 id="まとめ">まとめ</h2>

<h3 id="case-13-selectionの基本概念を理解">Case 1~3: <em>selection</em>の基本概念を理解</h3>

<ul>
  <li>update/enter/exitを感じよ</li>
  <li><em>selection</em>，DOM，データの絆を感じよ</li>
</ul>

<h3 id="case-4-関数化">Case 4: 関数化</h3>
<h3 id="case-58-装飾">Case 5~8: 装飾</h3>
<ol>
  <li>テキスト入れる</li>
  <li>アニメーション</li>
  <li>半径のスケール調整</li>
  <li>色</li>
</ol>

<h3 id="case-9-インタラクティブ">Case 9: インタラクティブ</h3>
<h3 id="case-10-入力エリア作り">Case 10: 入力エリア作り</h3>
<h3 id="case-11-乱数ボタン作り">Case 11: 乱数ボタン作り</h3>

      </section>
      
    </main>
    <script>
      const highlights = document.getElementsByClassName('highlighter-rouge');
      const h = highlights[0];
      for (const h of highlights) {
        const langName = h.className
          .split(' ')[0]
          .split('-')[1];
        const div = h.getElementsByTagName('div')[0];
        const p = document.createElement('span');
        const text = document.createTextNode(langName);
        p.appendChild(text);
        p.className = 'lang-name';
        div.appendChild(p);
      }
    </script>
  </body>
</html>

