<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="/assets/css/style.css">
    <title></title>
  </head>
  <body>

    <header>
      <div class="logo"></diV>
      <nav>
  <a href="/" >
    Home
  </a>
  <a href="/about.html" >
    About
  </a>
</nav>

    </header>

    <div class="wrapper">
      
      <div class="main">
        <!-- theme: uncover -->

<link rel="stylesheet" href="../theme/mytheme.css" />

<h2 id="case-9-click">Case 9: Click</h2>

<ul>
  <li>クリックされたボールは1増加させたい</li>
</ul>

<h3 id="two-kinds-of-method">Two Kinds of Method</h3>

<ol>
  <li>クリック
⇒ 該当データを探して1+して再bind</li>
  <li>クリック
⇒ DOMに結ばれたデータの値を直接1+してattr再設定</li>
</ol>

<p>何れにしても実装は少しめんどい</p>

<h3 id="common-comcept-selectionon">Common Comcept: <em>selection</em>.on</h3>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">circleGroupMerge</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'click'</span><span class="p">,</span> <span class="p">(</span><span class="nx">d</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="cm">/* d: クリックされた要素のデータ */</span>
<span class="p">})</span>
</code></pre></div></div>

<h4 id="1st-method">1st Method</h4>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">circleGroupMerge</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'click'</span><span class="p">,</span> <span class="p">(</span><span class="nx">d</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">data</span><span class="p">[</span><span class="nx">idx</span><span class="p">]</span><span class="o">++</span> <span class="c1">// idx: dがdata配列で何番目か</span>
  <span class="cm">/* 更新処理 */</span>
<span class="p">})</span>
</code></pre></div></div>

<h4 id="2st-method">2st Method</h4>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">circleGroupMerge</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'click'</span><span class="p">,</span> <span class="p">(</span><span class="nx">d</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">d</span><span class="o">++</span><span class="p">;</span> <span class="c1">// dを直接書き換える</span>
  <span class="cm">/* 更新処理 */</span>
<span class="p">})</span>
</code></pre></div></div>

<h3 id="1st-method-1">1st Method</h3>

<ul>
  <li>bindされたデータが元のデータ配列の
何番目なのかを知りたい
⇒ indexを持たせる</li>
</ul>

<h4 id="modified-formatdata">Modified formatData</h4>

<p>idx追加</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">formatData</span> <span class="o">=</span> <span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">space</span><span class="p">,</span> <span class="nx">rScale</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">now</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kd">const</span> <span class="nx">ret</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">d</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">t</span> <span class="o">=</span> <span class="p">{</span> 
      <span class="na">idx</span><span class="p">:</span> <span class="nx">i</span><span class="p">,</span> <span class="na">val</span><span class="p">:</span> <span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="na">r</span><span class="p">:</span> <span class="nx">rScale</span><span class="p">(</span><span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="p">]),</span>
      <span class="na">x</span><span class="p">:</span> <span class="nx">now</span><span class="p">,</span> <span class="na">y</span><span class="p">:</span> <span class="mi">0</span>
    <span class="p">};</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">data</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">now</span> <span class="o">+=</span> <span class="nx">rScale</span><span class="p">(</span><span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span> <span class="o">+</span> <span class="nx">space</span> <span class="o">+</span> <span class="nx">rScale</span><span class="p">(</span><span class="nx">data</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]);</span> 
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="nx">ret</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">d</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="nx">d</span><span class="p">.</span><span class="nx">x</span> <span class="o">-=</span> <span class="nx">now</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span> <span class="p">});</span>
  <span class="k">return</span> <span class="nx">ret</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div></div>

<h4 id="modified-update">Modified update()</h4>

<p>transition付きにはonclickが設定できないので
circleGroupMergeとtransitionを分離する
それに伴う変更もする</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">circleGroupMerge</span> <span class="o">=</span> <span class="nx">circleGroupEnter</span>
  <span class="p">.</span><span class="nx">merge</span><span class="p">(</span><span class="nx">circleGroup</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">circleGroupTrans</span> <span class="o">=</span> <span class="nx">circleGroupMerge</span><span class="p">.</span><span class="nx">transition</span><span class="p">(</span><span class="nx">t</span><span class="p">);</span>
<span class="nx">circleGroupTrans</span>
  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'transform'</span><span class="p">,</span> <span class="nx">d</span> <span class="o">=&gt;</span> <span class="s2">`translate(</span><span class="p">${</span><span class="nx">d</span><span class="p">.</span><span class="nx">x</span><span class="p">}</span><span class="s2">, </span><span class="p">${</span><span class="nx">d</span><span class="p">.</span><span class="nx">y</span><span class="p">}</span><span class="s2">)`</span><span class="p">);</span>

<span class="kd">const</span> <span class="p">[</span><span class="nx">rmin</span><span class="p">,</span> <span class="nx">rmax</span><span class="p">]</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">extent</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">d</span> <span class="o">=&gt;</span> <span class="nx">d</span><span class="p">.</span><span class="nx">val</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">colorScale</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">scaleLinear</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">domain</span><span class="p">([</span><span class="nx">rmin</span><span class="p">,</span> <span class="p">(</span><span class="nx">rmin</span> <span class="o">+</span> <span class="nx">rmax</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="nx">rmax</span><span class="p">])</span>
  <span class="p">.</span><span class="nx">range</span><span class="p">([</span><span class="s1">'orangered'</span><span class="p">,</span> <span class="s1">'white'</span><span class="p">,</span> <span class="s1">'skyblue'</span><span class="p">]);</span>
<span class="nx">circleGroupTrans</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s1">'circle'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'fill'</span><span class="p">,</span> <span class="nx">d</span> <span class="o">=&gt;</span> <span class="nx">colorScale</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">val</span><span class="p">))</span>
  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'stroke'</span><span class="p">,</span> <span class="s1">'#000'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'r'</span><span class="p">,</span> <span class="nx">d</span> <span class="o">=&gt;</span> <span class="nx">rScale</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">val</span><span class="p">));</span>
<span class="nx">circleGroupTrans</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s1">'text'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'text-anchor'</span><span class="p">,</span> <span class="s1">'middle'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'dominant-baseline'</span><span class="p">,</span> <span class="s1">'central'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="nx">d</span> <span class="o">=&gt;</span> <span class="nx">d</span><span class="p">.</span><span class="nx">val</span><span class="p">);</span>
</code></pre></div></div>

<h4 id="added-selectionon-in-update">Added <em>selection</em>.on in update()</h4>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">circleGroupMerge</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'click'</span><span class="p">,</span> <span class="nx">d</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">data</span><span class="p">[</span><span class="nx">d</span><span class="p">.</span><span class="nx">idx</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
  <span class="nx">update</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div></div>

<h3 id="2nd-method">2nd Method</h3>

<ul>
  <li>forceSimulationは内部的にこれをやってる(と思う)</li>
</ul>

<p>これだとうまくいかない</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">circleGroupMerge</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'click'</span><span class="p">,</span> <span class="nx">d</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">d</span><span class="p">.</span><span class="nx">val</span><span class="o">++</span><span class="p">;</span>
  <span class="nx">update</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div></div>

<ul>
  <li>DOMのデータは1+</li>
  <li>dataは無変更</li>
</ul>

<p>⇒ update(data)で変更が無かったことに</p>

<ul>
  <li><strong>データを追加/削除する処理</strong></li>
  <li><strong>circleの状態を変更する処理</strong></li>
</ul>

<p>を分けたくなってくる</p>

<h3 id="あまり良くない解決策冗長">あまり良くない解決策(∵冗長)</h3>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">circleGroupMerge</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'click'</span><span class="p">,</span> <span class="nx">d</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">d</span><span class="o">++</span><span class="p">;</span>
  <span class="nx">circleGroupMerge</span>
    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'transform'</span><span class="p">,</span> <span class="nx">d</span> <span class="o">=&gt;</span> <span class="s2">`translate(</span><span class="p">${</span><span class="nx">d</span><span class="p">.</span><span class="nx">x</span><span class="p">}</span><span class="s2">, </span><span class="p">${</span><span class="nx">d</span><span class="p">.</span><span class="nx">y</span><span class="p">}</span><span class="s2">)`</span><span class="p">);</span>
  <span class="nx">circleGroupMerge</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s1">'circle'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'fill'</span><span class="p">,</span> <span class="nx">d</span> <span class="o">=&gt;</span> <span class="nx">colorScale</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">val</span><span class="p">))</span>
    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'stroke'</span><span class="p">,</span> <span class="s1">'#000'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'r'</span><span class="p">,</span> <span class="nx">d</span> <span class="o">=&gt;</span> <span class="nx">rScale</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">val</span><span class="p">));</span>
  <span class="nx">circleGroupMerge</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s1">'text'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'text-anchor'</span><span class="p">,</span> <span class="s1">'middle'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'dominant-baseline'</span><span class="p">,</span> <span class="s1">'central'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="nx">d</span> <span class="o">=&gt;</span> <span class="nx">d</span><span class="p">.</span><span class="nx">val</span><span class="p">);</span>
  <span class="nx">circleGroupMerge</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s1">'text'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'text-anchor'</span><span class="p">,</span> <span class="s1">'middle'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'dominant-baseline'</span><span class="p">,</span> <span class="s1">'central'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="nx">d</span> <span class="o">=&gt;</span> <span class="nx">d</span><span class="p">.</span><span class="nx">val</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div></div>

<h4 id="これは設計を見直さなければならない予感">これは設計を見直さなければならない予感…</h4>

<h4 id="機能分離">機能分離</h4>

<ul>
  <li>formatData: データを有らまほしき形に変換する</li>
  <li>calcPosition: 円の中心位置を決定する</li>
  <li>adjustCirclesByData: データの追加/削除を担う</li>
  <li>decorateCircles: データのattr/style変更を担う</li>
  <li>update: primitiveデータ用のインターフェース</li>
</ul>

<p>今までのコードを大幅に変更します</p>

<h4 id="formatdata">formatData</h4>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">formatData</span> <span class="o">=</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">ret</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">data</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">ret</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
      <span class="na">val</span><span class="p">:</span> <span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span>
      <span class="na">x</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
      <span class="na">y</span><span class="p">:</span> <span class="mi">0</span>
    <span class="p">});</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">ret</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div></div>

<h4 id="calcposition">calcPosition</h4>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">calcPosition</span> <span class="o">=</span> <span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">space</span><span class="p">,</span> <span class="nx">rScale</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">now</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="nx">data</span><span class="p">.</span><span class="nx">forEach</span><span class="p">((</span><span class="nx">d</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">d</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="nx">now</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">data</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">now</span> <span class="o">+=</span> <span class="nx">rScale</span><span class="p">(</span><span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">val</span><span class="p">)</span> <span class="o">+</span> <span class="nx">space</span> <span class="o">+</span> <span class="nx">rScale</span><span class="p">(</span><span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="p">].</span><span class="nx">val</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">});</span>
  <span class="nx">data</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">d</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="nx">d</span><span class="p">.</span><span class="nx">x</span> <span class="o">-=</span> <span class="nx">now</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span> <span class="p">});</span>
  <span class="k">return</span> <span class="nx">data</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div></div>

<h4 id="adjustcirclesbydata">adjustCirclesByData</h4>

<p>クリックした時，該当データを直接書き換え</p>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">adjustCirclesByData</span> <span class="o">=</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">circleGroup</span> <span class="o">=</span> <span class="nx">g</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">'g.circle'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">data</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
  <span class="kd">const</span> <span class="nx">circleGroupEnter</span> <span class="o">=</span> <span class="nx">circleGroup</span><span class="p">.</span><span class="nx">enter</span><span class="p">()</span>
    <span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">'g'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">classed</span><span class="p">(</span><span class="s1">'circle'</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
  <span class="nx">circleGroupEnter</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">'circle'</span><span class="p">);</span>
  <span class="nx">circleGroupEnter</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">'text'</span><span class="p">);</span>

  <span class="kd">const</span> <span class="nx">circleGroupMerge</span> <span class="o">=</span> <span class="nx">circleGroupEnter</span>
    <span class="p">.</span><span class="nx">merge</span><span class="p">(</span><span class="nx">circleGroup</span><span class="p">);</span>
  <span class="nx">decorateCircles</span><span class="p">(</span><span class="nx">circleGroupMerge</span><span class="p">);</span>

  <span class="kd">const</span> <span class="nx">circleGroupExit</span> <span class="o">=</span> <span class="nx">circleGroup</span><span class="p">.</span><span class="nx">exit</span><span class="p">()</span>
    <span class="p">.</span><span class="nx">transition</span><span class="p">()</span>
    <span class="p">.</span><span class="nx">delay</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">duration</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
  <span class="nx">circleGroupExit</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s1">'circle'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'r'</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
  <span class="nx">circleGroupExit</span><span class="p">.</span><span class="nx">remove</span><span class="p">();</span>

  <span class="nx">circleGroupMerge</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'click'</span><span class="p">,</span> <span class="nx">d</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">d</span><span class="p">.</span><span class="nx">val</span><span class="o">++</span><span class="p">;</span>
      <span class="nx">decorateCircles</span><span class="p">(</span><span class="nx">circleGroupMerge</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">};</span>
</code></pre></div></div>

<h4 id="decoratecircles-12">decorateCircles 1/2</h4>

<p><em>selection</em> を引数にとるちょっと奇妙な関数</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">decorateCircles</span> <span class="o">=</span> <span class="p">(</span><span class="nx">circleGroup</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">circleGroup</span><span class="p">.</span><span class="nx">data</span><span class="p">();</span>
  <span class="kd">const</span> <span class="nx">rScale</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">scaleLinear</span><span class="p">()</span>
    <span class="p">.</span><span class="nx">domain</span><span class="p">(</span><span class="nx">d3</span><span class="p">.</span><span class="nx">extent</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">d</span> <span class="o">=&gt;</span> <span class="nx">d</span><span class="p">.</span><span class="nx">val</span><span class="p">))</span>
    <span class="p">.</span><span class="nx">range</span><span class="p">([</span><span class="mi">10</span><span class="p">,</span> <span class="mi">50</span><span class="p">]);</span>
  <span class="nx">calcPosition</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="nx">rScale</span><span class="p">);</span>
  <span class="kd">const</span> <span class="p">[</span><span class="nx">rmin</span><span class="p">,</span> <span class="nx">rmax</span><span class="p">]</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">extent</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">d</span> <span class="o">=&gt;</span> <span class="nx">d</span><span class="p">.</span><span class="nx">val</span><span class="p">);</span>
  <span class="kd">const</span> <span class="nx">colorScale</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">scaleLinear</span><span class="p">()</span>
    <span class="p">.</span><span class="nx">domain</span><span class="p">([</span><span class="nx">rmin</span><span class="p">,</span> <span class="p">(</span><span class="nx">rmin</span> <span class="o">+</span> <span class="nx">rmax</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="nx">rmax</span><span class="p">])</span>
    <span class="p">.</span><span class="nx">range</span><span class="p">([</span><span class="s1">'skyblue'</span><span class="p">,</span> <span class="s1">'white'</span><span class="p">,</span> <span class="s1">'orangered'</span><span class="p">]);</span>
  <span class="kd">const</span> <span class="nx">circleGroupTrans</span> <span class="o">=</span> <span class="nx">circleGroup</span>
    <span class="p">.</span><span class="nx">transition</span><span class="p">()</span>
    <span class="p">.</span><span class="nx">delay</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">duration</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>

  <span class="nx">circleGroupTrans</span>
    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'transform'</span><span class="p">,</span> <span class="nx">d</span> <span class="o">=&gt;</span> <span class="s2">`translate(</span><span class="p">${</span><span class="nx">d</span><span class="p">.</span><span class="nx">x</span><span class="p">}</span><span class="s2">, </span><span class="p">${</span><span class="nx">d</span><span class="p">.</span><span class="nx">y</span><span class="p">}</span><span class="s2">)`</span><span class="p">);</span>
  <span class="nx">circleGroupTrans</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s1">'circle'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'fill'</span><span class="p">,</span> <span class="nx">d</span> <span class="o">=&gt;</span> <span class="nx">colorScale</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">val</span><span class="p">))</span>
    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'stroke'</span><span class="p">,</span> <span class="s1">'#000'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'r'</span><span class="p">,</span> <span class="nx">d</span> <span class="o">=&gt;</span> <span class="nx">rScale</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">val</span><span class="p">));</span>
  <span class="nx">circleGroupTrans</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s1">'text'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'text-anchor'</span><span class="p">,</span> <span class="s1">'middle'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'dominant-baseline'</span><span class="p">,</span> <span class="s1">'central'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="nx">d</span> <span class="o">=&gt;</span> <span class="nx">d</span><span class="p">.</span><span class="nx">val</span><span class="p">);</span>
  <span class="nx">circleGroupTrans</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s1">'text'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'text-anchor'</span><span class="p">,</span> <span class="s1">'middle'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'dominant-baseline'</span><span class="p">,</span> <span class="s1">'central'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="nx">d</span> <span class="o">=&gt;</span> <span class="nx">d</span><span class="p">.</span><span class="nx">val</span><span class="p">);</span>
<span class="p">};</span>
</code></pre></div></div>

<h4 id="update">update</h4>

<p>formatDataでデータを適当な形に変換したものに対して
adjustCirclesByDataを適用する</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">update</span> <span class="o">=</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">adjustCirclesByData</span><span class="p">(</span><span class="nx">formatData</span><span class="p">(</span><span class="nx">data</span><span class="p">));</span>
<span class="p">};</span>
</code></pre></div></div>

<p><img src="/d3js/Part01/img/circle18.gif" alt="bg contain" /></p>

<h3 id="caution">Caution</h3>

<ul>
  <li>D3.jsはデータ可視化のためのライブラリ</li>
  <li>今回の例みたいに
「インタラクティブにデータを書き換える」
ことは本来の使い方ではないことを心に留める</li>
</ul>

<h3 id="other-applications">Other Applications</h3>

<ol>
  <li>データ書き換え以外のインタラクティブ要素
ex) マウスを乗せると座標が表示される</li>
  <li><strong>データの動きを見たい</strong></li>
</ol>

<p><img src="/d3js/Part01/img/otherapplication.png" alt="bg contain" /></p>

<h4 id="1st-method-2">1st Method</h4>

<ul>
  <li>実装楽</li>
  <li>用意すべきデータが2stに比べ多い</li>
</ul>

<h4 id="2nd-method-1">2nd Method</h4>

<ul>
  <li>差分だけ更新
⇒ 用意すべきデータが1stに比べ少ない</li>
  <li>データの持たせ方が難しい時がある</li>
</ul>

<h2 id="case-10-input-area">Case 10: Input Area</h2>

<p><img src="/d3js/Part01/img/layout.png" alt="center w:900px" /></p>
<ul>
  <li>入力エリアをちゃんと作ろう</li>
  <li>練習として複数行入力に対応できるようにする</li>
</ul>

<h3 id="indexhtml">index.html</h3>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"main-container"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"menu"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"main"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;svg&gt;</span>
    <span class="nt">&lt;/svg&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</code></pre></div></div>

<h3 id="stylecss">style.css</h3>

<div class="language-css highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">.main-container</span> <span class="p">{</span>
  <span class="nl">display</span><span class="p">:</span> <span class="n">flex</span><span class="p">;</span>
  <span class="nl">flex-direction</span><span class="p">:</span> <span class="n">row</span><span class="p">;</span>
<span class="p">}</span>
<span class="nc">.menu</span> <span class="p">{</span>
  <span class="nl">display</span><span class="p">:</span> <span class="n">flex</span><span class="p">;</span>
  <span class="nl">flex-direction</span><span class="p">:</span> <span class="n">column</span><span class="p">;</span>
<span class="p">}</span>
<span class="nt">svg</span> <span class="p">{</span>
  <span class="nl">border</span><span class="p">:</span> <span class="m">1px</span> <span class="nb">solid</span> <span class="m">#000</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="added-scriptjs">Added script.js</h3>

<ul>
  <li>textarea.property(‘value’)でテキストエリアの内容を取得</li>
  <li>d3.merge([1], [2, 3], [4, 5]) → [1, 2, 3, 4, 5]</li>
  <li>Nubmer(d)でdを数値に変換</li>
</ul>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">menu</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s1">'.menu'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">textarea</span> <span class="o">=</span> <span class="nx">menu</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">'textarea'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">style</span><span class="p">(</span><span class="s1">'height'</span><span class="p">,</span> <span class="s2">`</span><span class="p">${</span><span class="nx">svgHeight</span> <span class="o">-</span> <span class="mi">30</span><span class="p">}</span><span class="s2">px`</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">genButton</span> <span class="o">=</span> <span class="nx">menu</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">'input'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'height'</span><span class="p">,</span> <span class="s1">'30px'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'type'</span><span class="p">,</span> <span class="s1">'button'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'value'</span><span class="p">,</span> <span class="s1">'generate'</span><span class="p">);</span>

<span class="nx">genButton</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'click'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">input</span> <span class="o">=</span> <span class="nx">textarea</span><span class="p">.</span><span class="nx">property</span><span class="p">(</span><span class="s1">'value'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">'</span><span class="err">\</span><span class="s1">n'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">d</span> <span class="o">=&gt;</span> <span class="nx">d</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">' '</span><span class="p">));</span>
  <span class="kd">const</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">merge</span><span class="p">(</span><span class="nx">input</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">d</span> <span class="o">=&gt;</span> <span class="nb">Number</span><span class="p">(</span><span class="nx">d</span><span class="p">));</span>
  <span class="nx">update</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div></div>

<h2 id="まとめ">まとめ</h2>

<h3 id="case-13-selectionの基本概念を理解">Case 1~3: <em>selection</em>の基本概念を理解</h3>

<ul>
  <li>update/enter/exitを感じよ</li>
  <li><em>selection</em>，DOM，データの絆を感じよ</li>
</ul>

<h3 id="case-4-関数化">Case 4: 関数化</h3>
<h3 id="case-58-装飾">Case 5~8: 装飾</h3>
<ol>
  <li>テキスト入れる</li>
  <li>アニメーション</li>
  <li>半径のスケール調整</li>
  <li>色</li>
</ol>

<h3 id="case-9-インタラクティブ">Case 9: インタラクティブ</h3>
<h3 id="case-10-入力エリア作り">Case 10: 入力エリア作り</h3>

      </div>
    </div>
    <script>
      const highlights = document.getElementsByClassName('highlighter-rouge');
      const h = highlights[0];
      for (const h of highlights) {
        const langName = h.className
          .split(' ')[0]
          .split('-')[1];
        const div = h.getElementsByTagName('div')[0];
        const p = document.createElement('span');
        const text = document.createTextNode(langName);
        p.appendChild(text);
        p.className = 'lang-name';
        div.appendChild(p);
      }
    </script>
  </body>
</html>

